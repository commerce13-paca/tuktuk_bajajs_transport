<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#007AFF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>VTC Mahajanga 401 - Transport & Boutique</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <style>
        /* ===== VARIABLES ===== */
        :root {
            --primary: #007AFF;
            --primary-dark: #0056CC;
            --secondary: #0f172a;
            --card-bg: #1e293b;
            --text: #f8fafc;
            --text-secondary: #8E8E93;
            --success: #34C759;
            --danger: #FF3B30;
            --warning: #FF9500;
            --accent: #5856D6;
            --border: #334155;
            --shop-primary: #FF6B6B;
            --shop-secondary: #4ECDC4;
            --background: #000000;
            --tuktuk-color: #FF9500;
            --scooter-color: #34C759;
            --van-color: #5856D6;
            --partner-color: #9C27B0;
            --admin-color: #FF9500;
            
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.15);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.3);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            
            --header-height: 60px;
            --nav-height: 70px;
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
        }

        /* ===== ANIMATIONS ===== */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideInBottom {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        @keyframes cartPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes notification {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes loading {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes rideProgress {
            from { width: 0%; }
            to { width: 100%; }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @keyframes newsSlide {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        /* ===== RESET & BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
        }

        html {
            font-size: 16px;
            height: 100%;
            overflow: hidden;
        }

        body {
            background: var(--background);
            color: var(--text);
            height: 100vh;
            height: -webkit-fill-available;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding: var(--safe-area-top) 0 var(--safe-area-bottom);
            position: fixed;
            width: 100%;
        }

        /* ===== STRUCTURE APP MOBILE ===== */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: -webkit-fill-available;
            background: var(--background);
            position: relative;
        }

        /* ===== HEADER MOBILE ===== */
        .app-header {
            background: var(--secondary);
            padding: var(--space-sm) var(--space-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            height: var(--header-height);
            min-height: var(--header-height);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            cursor: pointer;
        }

        .logo-icon {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: var(--shadow-sm);
        }

        .logo-icon img {
            width: 30px;
            height: 30px;
            object-fit: contain;
            border-radius: var(--radius-sm);
        }

        .logo-text {
            font-size: 14px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: none;
        }

        @media (min-width: 400px) {
            .logo-text {
                display: block;
            }
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .notification-icon {
            position: relative;
            cursor: pointer;
            font-size: 20px;
            color: var(--text);
            padding: 8px;
        }

        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--danger);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 5px;
            border-radius: 10px;
            min-width: 16px;
            text-align: center;
            animation: pulse 1.5s infinite;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .user-avatar:hover {
            transform: scale(1.1);
            border-color: var(--primary);
        }

        .cart-icon {
            position: relative;
            cursor: pointer;
            font-size: 20px;
            color: var(--shop-primary);
            transition: all 0.3s;
            padding: 8px;
        }

        .cart-icon:hover {
            transform: scale(1.1);
            color: var(--shop-secondary);
        }

        .cart-count {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--danger);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 5px;
            border-radius: 10px;
            min-width: 16px;
            text-align: center;
            animation: cartPulse 2s infinite;
        }

        /* ===== NAVIGATION MOBILE ===== */
        .nav-tabs {
            display: flex;
            background: var(--secondary);
            overflow-x: auto;
            scrollbar-width: none;
            border-top: 1px solid var(--border);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: var(--nav-height);
            min-height: var(--nav-height);
            padding-bottom: var(--safe-area-bottom);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }

        .nav-tab {
            flex: 1;
            min-width: 60px;
            padding: var(--space-sm);
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all 0.3s;
            position: relative;
            white-space: nowrap;
            height: 100%;
            justify-content: center;
        }

        .nav-tab i {
            font-size: 18px;
            transition: all 0.3s;
        }

        .nav-tab:hover {
            color: var(--text);
            background: rgba(255, 255, 255, 0.05);
        }

        .nav-tab.active {
            color: var(--primary);
            font-weight: 600;
        }

        .nav-tab.active i {
            color: var(--primary);
            animation: bounce 0.5s ease;
            transform: translateY(-2px);
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 3px;
            background: var(--primary);
            border-radius: 2px;
        }

        .nav-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--danger);
            color: white;
            font-size: 9px;
            font-weight: 700;
            padding: 2px 5px;
            border-radius: 10px;
            min-width: 16px;
            text-align: center;
            animation: pulse 1.5s infinite;
        }

        /* ===== MESSAGES NAV BADGE ===== */
        .nav-tab.messages-tab {
            position: relative;
        }

        .messages-nav-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            font-size: 9px;
            font-weight: 700;
            padding: 2px 5px;
            border-radius: 10px;
            min-width: 16px;
            text-align: center;
            animation: pulse 1.5s infinite;
        }

        /* ===== MAIN CONTENT MOBILE ===== */
        .main-content {
            flex: 1;
            overflow: hidden;
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            padding-bottom: var(--nav-height);
            position: relative;
        }

        .page {
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            display: none;
            animation: fadeIn 0.3s ease;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .page.active {
            display: block;
        }

        .page-content {
            padding: var(--space-md);
            padding-bottom: calc(var(--nav-height) + var(--space-md));
        }

        /* ===== CARD STYLES MOBILE ===== */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            margin-bottom: var(--space-md);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-md);
            transition: all 0.3s;
            animation: fadeIn 0.4s ease;
        }

        .card:active {
            transform: scale(0.98);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-md);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: 16px;
            font-weight: 600;
        }

        .card-title i {
            color: var(--primary);
            font-size: 18px;
        }

        /* ===== ADMIN STYLES ===== */
        .admin-panel {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            margin-bottom: var(--space-md);
        }

        .admin-nav {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
            overflow-x: auto;
            scrollbar-width: none;
        }

        .admin-nav::-webkit-scrollbar {
            display: none;
        }

        .admin-tab {
            padding: var(--space-sm) var(--space-md);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            font-size: 14px;
        }

        .admin-tab.active {
            background: var(--admin-color);
            color: white;
            border-color: var(--admin-color);
        }

        .admin-section {
            display: none;
        }

        .admin-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-md);
            padding: var(--space-sm);
            text-align: center;
        }

        .stat-number {
            font-size: 20px;
            font-weight: 700;
            color: var(--admin-color);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: var(--space-md);
        }

        .admin-table th,
        .admin-table td {
            padding: var(--space-sm);
            text-align: left;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
        }

        .admin-table th {
            background: rgba(255, 255, 255, 0.05);
            font-weight: 600;
            color: var(--admin-color);
        }

        .admin-action-btn {
            padding: 4px 8px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 11px;
            margin: 0 2px;
        }

        .admin-action-btn.edit {
            background: var(--warning);
        }

        .admin-action-btn.delete {
            background: var(--danger);
        }

        .admin-action-btn.block {
            background: var(--danger);
        }

        .admin-action-btn.approve {
            background: var(--success);
        }

        /* ===== SHOP STYLES MOBILE ===== */
        .shop-category {
            margin-bottom: var(--space-lg);
        }

        .category-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: var(--space-md);
            padding-bottom: var(--space-sm);
            border-bottom: 2px solid var(--shop-primary);
            color: var(--shop-primary);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .category-title.partner {
            border-bottom: 2px solid var(--partner-color);
            color: var(--partner-color);
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: var(--space-sm);
        }

        @media (min-width: 480px) {
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }
        }

        .product-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-md);
            padding: var(--space-sm);
            border: 2px solid transparent;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .product-card:active {
            transform: scale(0.95);
        }

        .product-card.featured {
            border-color: var(--shop-primary);
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.1), rgba(78, 205, 196, 0.1));
        }

        .product-card.partner-product {
            border-color: var(--partner-color);
            background: linear-gradient(135deg, rgba(156, 39, 176, 0.1), rgba(156, 39, 176, 0.05));
        }

        .product-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--shop-primary);
            color: white;
            padding: 3px 6px;
            border-radius: var(--radius-sm);
            font-size: 10px;
            font-weight: 600;
            z-index: 1;
        }

        .product-badge.partner {
            background: var(--partner-color);
        }

        .product-image {
            width: 100%;
            height: 100px;
            background: linear-gradient(135deg, var(--shop-primary), var(--shop-secondary));
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            margin-bottom: var(--space-sm);
            overflow: hidden;
            position: relative;
        }

        .product-image.partner {
            background: linear-gradient(135deg, var(--partner-color), #BA68C8);
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .partner-badge {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(156, 39, 176, 0.9);
            color: white;
            padding: 4px;
            font-size: 10px;
            text-align: center;
            border-radius: 0 0 var(--radius-sm) var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .product-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
            line-height: 1.2;
        }

        .product-description {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: var(--space-sm);
            height: 32px;
            overflow: hidden;
            line-height: 1.3;
        }

        .product-benefits {
            margin: var(--space-sm) 0;
            padding: var(--space-sm);
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-sm);
            font-size: 11px;
        }

        .benefit-item {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
            color: var(--success);
        }

        .benefit-item i {
            font-size: 10px;
        }

        .product-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--space-sm);
        }

        .product-price {
            font-weight: 700;
            color: var(--shop-primary);
            font-size: 16px;
        }

        .product-price.partner {
            color: var(--partner-color);
        }

        .product-rating {
            display: flex;
            align-items: center;
            gap: 1px;
            font-size: 10px;
            color: #FFD700;
        }

        .add-to-cart {
            background: var(--shop-primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            padding: 6px 10px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
        }

        .add-to-cart.partner {
            background: var(--partner-color);
        }

        .add-to-cart:active {
            transform: scale(0.95);
        }

        /* ===== NEWS SLIDER STYLES ===== */
        .news-slider {
            display: flex;
            gap: var(--space-md);
            overflow-x: auto;
            scrollbar-width: none;
            padding: var(--space-sm) 0;
            margin: 0 calc(-1 * var(--space-md));
            padding: 0 var(--space-md);
            -webkit-overflow-scrolling: touch;
        }

        .news-slider::-webkit-scrollbar {
            display: none;
        }

        .news-item {
            min-width: 280px;
            background: linear-gradient(135deg, rgba(0,122,255,0.1), rgba(88,86,214,0.1));
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .news-item:active {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .news-category {
            display: inline-block;
            padding: 4px 12px;
            background: var(--primary);
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: var(--space-sm);
        }

        .news-category.event {
            background: var(--accent);
        }

        .news-category.promotion {
            background: var(--warning);
        }

        .news-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: var(--space-sm);
            line-height: 1.4;
        }

        .news-excerpt {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: var(--space-md);
            line-height: 1.5;
        }

        .news-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* ===== ORDER SUMMARY MOBILE ===== */
        .order-summary {
            background: var(--secondary);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            margin-top: var(--space-lg);
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--space-sm);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        .summary-total {
            display: flex;
            justify-content: space-between;
            font-size: 18px;
            font-weight: 700;
            margin-top: var(--space-md);
            padding-top: var(--space-md);
            border-top: 2px solid var(--shop-primary);
        }

        /* ===== DELIVERY CALCULATOR MOBILE ===== */
        .delivery-calc {
            background: rgba(0, 122, 255, 0.1);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            margin: var(--space-md) 0;
        }

        .distance-display {
            font-size: 20px;
            font-weight: 700;
            text-align: center;
            margin: var(--space-sm) 0;
            color: var(--primary);
        }

        .price-breakdown {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-md);
            padding: var(--space-sm);
            margin-top: var(--space-sm);
        }

        .price-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--space-xs);
            font-size: 12px;
        }

        /* ===== MAP STYLES MOBILE ===== */
        .map-container {
            height: 300px;
            border-radius: var(--radius-lg);
            overflow: hidden;
            position: relative;
            background: #000;
            border: 1px solid var(--border);
            margin-bottom: var(--space-md);
        }

        @media (min-height: 700px) {
            .map-container {
                height: 350px;
            }
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
        }

        .map-controls {
            position: absolute;
            bottom: var(--space-md);
            right: var(--space-md);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .map-control-btn {
            background: rgba(28, 28, 30, 0.95);
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text);
            font-size: 18px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
            box-shadow: var(--shadow-sm);
        }

        .map-control-btn:active {
            transform: scale(0.9);
        }

        /* ===== RIDE TRACKING ===== */
        .ride-tracking {
            position: fixed;
            bottom: calc(var(--nav-height) + var(--space-md));
            left: var(--space-md);
            right: var(--space-md);
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            z-index: 999;
            animation: slideInBottom 0.3s ease;
        }

        .ride-tracking.hidden {
            display: none;
        }

        .ride-info {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-bottom: var(--space-sm);
        }

        .ride-driver-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .ride-driver-info {
            flex: 1;
        }

        .ride-driver-name {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .ride-vehicle {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .ride-progress {
            margin: var(--space-md) 0;
        }

        .progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .ride-actions {
            display: flex;
            gap: var(--space-sm);
        }

        .ride-action-btn {
            flex: 1;
            padding: 10px;
            border-radius: var(--radius-md);
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 14px;
        }

        .ride-action-btn.call {
            background: var(--success);
            color: white;
        }

        .ride-action-btn.message {
            background: var(--primary);
            color: white;
        }

        .ride-action-btn.cancel {
            background: var(--danger);
            color: white;
        }

        /* ===== MESSAGES STYLES ===== */
        .messages-container {
            height: 400px;
            border-radius: var(--radius-md);
            overflow: hidden;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            margin-bottom: var(--space-md);
        }

        .messages-list {
            height: 100%;
            overflow-y: auto;
            padding: var(--space-sm);
        }

        .message {
            margin-bottom: var(--space-sm);
            padding: var(--space-sm);
            border-radius: var(--radius-md);
            max-width: 80%;
            animation: fadeIn 0.3s ease;
        }

        .message.received {
            background: rgba(255, 255, 255, 0.05);
            margin-right: auto;
        }

        .message.sent {
            background: rgba(0, 122, 255, 0.2);
            margin-left: auto;
        }

        .message-sender {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 12px;
        }

        .message-text {
            font-size: 14px;
        }

        .message-time {
            font-size: 10px;
            color: var(--text-secondary);
            text-align: right;
            margin-top: 4px;
        }

        .message-input-container {
            display: flex;
            gap: var(--space-sm);
        }

        .message-input {
            flex: 1;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text);
            font-size: 14px;
        }

        .message-send-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* ===== MESSAGES PAGE STYLES ===== */
        .conversations-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .conversation-item {
            display: flex;
            align-items: center;
            padding: var(--space-sm);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s;
        }

        .conversation-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .conversation-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: var(--space-sm);
            overflow: hidden;
        }

        .conversation-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .conversation-info {
            flex: 1;
            min-width: 0;
        }

        .conversation-user {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .conversation-preview {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .conversation-time {
            font-size: 10px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .conversation-unread {
            background: var(--primary);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        /* ===== SOCIAL MEDIA STYLES MOBILE ===== */
        .post-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-md);
            border: 1px solid var(--border);
            overflow: hidden;
            animation: fadeIn 0.4s ease;
        }

        .post-header {
            padding: var(--space-sm);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            border-bottom: 1px solid var(--border);
        }

        .post-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            flex-shrink: 0;
            overflow: hidden;
        }

        .post-user-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .post-user-info {
            flex: 1;
            min-width: 0;
        }

        .post-user-name {
            font-weight: 600;
            margin-bottom: 2px;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .post-user-name:hover {
            color: var(--primary);
        }

        .post-time {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .post-content {
            padding: var(--space-sm);
        }

        .post-text {
            margin-bottom: var(--space-sm);
            line-height: 1.5;
            font-size: 14px;
        }

        .post-media {
            margin-top: var(--space-sm);
            border-radius: var(--radius-md);
            overflow: hidden;
            position: relative;
            background: #000;
        }

        .post-media img {
            width: 100%;
            height: auto;
            max-height: 400px;
            object-fit: cover;
            display: block;
        }

        .post-media video {
            width: 100%;
            height: auto;
            max-height: 400px;
            display: block;
            background: #000;
            border-radius: var(--radius-md);
        }

        /* VIDÉOS VERTICALES */
        .vertical-video-container {
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            position: relative;
            background: #000;
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .vertical-video {
            width: 100%;
            height: 500px;
            object-fit: cover;
            display: block;
        }

        /* Contrôles vidéo améliorés */
        .video-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 15px;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
            z-index: 10;
        }

        .video-control-btn {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 12px;
            border-radius: 50%;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .video-control-btn:active {
            background: rgba(0, 0, 0, 0.8);
            border-color: var(--primary);
            transform: scale(0.9);
        }

        .post-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .post-tag {
            color: var(--primary);
            font-size: 12px;
            background: rgba(0, 122, 255, 0.1);
            padding: 4px 8px;
            border-radius: 12px;
        }

        .post-stats {
            padding: 0 var(--space-sm) var(--space-sm);
            display: flex;
            gap: var(--space-md);
            font-size: 12px;
            color: var(--text-secondary);
            justify-content: space-around;
        }

        .post-actions {
            padding: var(--space-sm);
            border-top: 1px solid var(--border);
            display: flex;
            gap: var(--space-md);
            justify-content: space-around;
        }

        .post-action {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            padding: 6px;
            border-radius: var(--radius-sm);
            flex: 1;
            justify-content: center;
            font-size: 12px;
        }

        .post-action:active {
            background: rgba(255, 255, 255, 0.05);
        }

        .post-action.active {
            color: var(--primary);
        }

        .post-action.liked {
            color: var(--danger);
        }

        .post-action.message {
            color: var(--primary);
        }

        .post-action.message:hover {
            background: rgba(0, 122, 255, 0.1);
        }

        .post-comments {
            padding: var(--space-sm);
            border-top: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.03);
        }

        .comment {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-sm);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .comment:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }

        .comment-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
            overflow: hidden;
        }

        .comment-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .comment-content {
            flex: 1;
            min-width: 0;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
            align-items: center;
        }

        .comment-user {
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .comment-user:hover {
            color: var(--primary);
        }

        .comment-time {
            font-size: 10px;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .comment-text {
            font-size: 12px;
            line-height: 1.3;
        }

        .comment-actions {
            display: flex;
            gap: var(--space-sm);
            margin-top: 4px;
            font-size: 10px;
        }

        .comment-action {
            color: var(--text-secondary);
            cursor: pointer;
        }

        .comment-action:active {
            color: var(--primary);
        }

        .comment-form {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-sm);
            align-items: center;
        }

        .comment-input {
            flex: 1;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text);
            font-size: 12px;
            min-height: 36px;
            max-height: 80px;
            resize: vertical;
        }

        .comment-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .comment-send-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .comment-send-btn:active {
            transform: scale(0.9);
        }

        /* ===== CREATE POST MOBILE ===== */
        .create-post {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: var(--space-sm);
            margin-bottom: var(--space-md);
            border: 2px dashed var(--border);
            transition: all 0.3s;
        }

        .create-post:active {
            border-color: var(--primary);
            background: rgba(0, 122, 255, 0.05);
        }

        .create-post-header {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-sm);
        }

        .post-input {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text);
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
        }

        .post-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .post-options {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-sm);
            flex-wrap: wrap;
        }

        .post-option {
            flex: 1;
            min-width: 80px;
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
            font-size: 12px;
        }

        .post-option:active {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--primary);
        }

        .post-option i {
            font-size: 18px;
            margin-bottom: 4px;
            display: block;
        }

        .media-preview {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-sm);
            flex-wrap: wrap;
        }

        .media-preview-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: var(--radius-sm);
            overflow: hidden;
            background: #000;
        }

        .media-preview-item img, .media-preview-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .media-preview-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
        }

        /* ===== PROFILE PAGE MOBILE ===== */
        .profile-header {
            text-align: center;
            margin-bottom: var(--space-lg);
        }

        .profile-avatar-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            margin: 0 auto var(--space-sm);
            border: 4px solid var(--card-bg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }

        .profile-avatar-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-avatar-large .avatar-edit-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            border-radius: 50%;
        }

        .profile-avatar-large:hover .avatar-edit-overlay {
            opacity: 1;
        }

        .profile-stats {
            display: flex;
            justify-content: space-around;
            margin: var(--space-md) 0;
            gap: var(--space-sm);
        }

        .stat-item {
            text-align: center;
            cursor: pointer;
            flex: 1;
            padding: var(--space-sm);
            border-radius: var(--radius-md);
            transition: all 0.3s;
        }

        .stat-item:active {
            background: rgba(255, 255, 255, 0.05);
        }

        .stat-number {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 2px;
            color: var(--primary);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .wallet-info {
            background: linear-gradient(135deg, var(--shop-primary), var(--shop-secondary));
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            text-align: center;
            margin: var(--space-md) 0;
            color: white;
        }

        .wallet-amount {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .wallet-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .order-history {
            margin-top: var(--space-lg);
        }

        .order-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-md);
            padding: var(--space-sm);
            margin-bottom: var(--space-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--space-sm);
        }

        .order-info {
            flex: 1;
            min-width: 0;
        }

        .order-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .order-details {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .order-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            white-space: nowrap;
        }

        .status-delivered {
            background: rgba(52, 199, 89, 0.2);
            color: var(--success);
        }

        .status-pending {
            background: rgba(255, 149, 0, 0.2);
            color: var(--warning);
        }

        .status-cancelled {
            background: rgba(255, 59, 48, 0.2);
            color: var(--danger);
        }

        .status-preparing {
            background: rgba(0, 122, 255, 0.2);
            color: var(--primary);
        }

        .status-active {
            background: rgba(52, 199, 89, 0.2);
            color: var(--success);
        }

        .status-completed {
            background: rgba(0, 122, 255, 0.2);
            color: var(--primary);
        }

        /* ===== TRANSPORT PAGE MOBILE ===== */
        .ride-type-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-sm);
            margin: var(--space-md) 0;
        }

        @media (min-width: 400px) {
            .ride-type-selector {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .ride-type {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-md);
            padding: var(--space-sm);
            text-align: center;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }

        .ride-type:active {
            transform: scale(0.98);
        }

        .ride-type.selected {
            border-color: var(--primary);
            background: rgba(0, 122, 255, 0.1);
        }

        .ride-type-icon {
            font-size: 24px;
            margin-bottom: 4px;
            color: var(--primary);
        }

        .ride-type-name {
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 2px;
        }

        .ride-type-price {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .input-group {
            margin-bottom: var(--space-md);
        }

        .input-label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-secondary);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text);
            font-size: 14px;
            transition: all 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
        }

        .driver-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-md);
            padding: var(--space-sm);
            margin-bottom: var(--space-sm);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            border: 2px solid transparent;
            transition: all 0.3s;
            cursor: pointer;
        }

        .driver-card:active {
            transform: scale(0.98);
        }

        .driver-card.selected {
            border-color: var(--primary);
            background: rgba(0, 122, 255, 0.1);
        }

        .driver-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            flex-shrink: 0;
            overflow: hidden;
        }

        .driver-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .driver-info {
            flex: 1;
            min-width: 0;
        }

        .driver-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .driver-vehicle {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .driver-rating {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: #FFD700;
        }

        .driver-price {
            font-weight: 700;
            font-size: 16px;
            color: var(--primary);
            text-align: right;
            white-space: nowrap;
        }

        .ride-estimate {
            background: rgba(0, 122, 255, 0.1);
            border-radius: var(--radius-md);
            padding: var(--space-sm);
            margin: var(--space-md) 0;
            text-align: center;
        }

        .estimate-price {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
            margin: 4px 0;
        }

        .estimate-time {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* ===== MODALS MOBILE ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-md);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: var(--radius-xl);
            padding: var(--space-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            animation: slideInBottom 0.3s ease;
            position: relative;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--border);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-sm);
            transition: all 0.3s;
        }

        .modal-close:active {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
        }

        /* ===== BUTTONS MOBILE ===== */
        .btn {
            padding: 14px 20px;
            border-radius: var(--radius-md);
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
            width: 100%;
            -webkit-appearance: none;
            touch-action: manipulation;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 15px rgba(0, 122, 255, 0.3);
        }

        .btn-primary:active {
            box-shadow: 0 2px 10px rgba(0, 122, 255, 0.2);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #2ecc71);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #e74c3c);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #f39c12);
            color: white;
        }

        .btn-shop {
            background: linear-gradient(135deg, var(--shop-primary), var(--shop-secondary));
            color: white;
        }

        .btn-partner {
            background: linear-gradient(135deg, var(--partner-color), #BA68C8);
            color: white;
        }

        .btn-admin {
            background: linear-gradient(135deg, var(--admin-color), #f39c12);
            color: white;
        }

        .btn-block {
            width: 100%;
        }

        .btn-sm {
            padding: 10px 16px;
            font-size: 14px;
        }

        /* ===== LOADING & STATES ===== */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: loading 1s ease-in-out infinite;
        }

        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.1) 25%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0.1) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--radius-md);
        }

        .hidden {
            display: none !important;
        }

        .visible {
            display: block !important;
        }

        .text-center {
            text-align: center;
        }

        .text-muted {
            color: var(--text-secondary);
        }

        .mt-1 { margin-top: var(--space-xs); }
        .mt-2 { margin-top: var(--space-sm); }
        .mt-3 { margin-top: var(--space-md); }
        .mt-4 { margin-top: var(--space-lg); }

        .mb-1 { margin-bottom: var(--space-xs); }
        .mb-2 { margin-bottom: var(--space-sm); }
        .mb-3 { margin-bottom: var(--space-md); }
        .mb-4 { margin-bottom: var(--space-lg); }

        .d-flex {
            display: flex;
        }

        .align-items-center {
            align-items: center;
        }

        .justify-content-between {
            justify-content: space-between;
        }

        .flex-column {
            flex-direction: column;
        }

        .flex-1 {
            flex: 1;
        }

        .w-100 {
            width: 100%;
        }

        .gap-1 { gap: var(--space-xs); }
        .gap-2 { gap: var(--space-sm); }
        .gap-3 { gap: var(--space-md); }
        .gap-4 { gap: var(--space-lg); }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* ===== PWA STYLES ===== */
        .pwa-install-prompt {
            position: fixed;
            bottom: calc(var(--nav-height) + var(--space-md));
            left: var(--space-md);
            right: var(--space-md);
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            z-index: 1500;
            animation: slideInBottom 0.3s ease;
        }

        .pwa-install-prompt.hidden {
            display: none;
        }

        .pwa-install-content {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .pwa-install-icon {
            font-size: 32px;
            color: var(--primary);
        }

        .pwa-install-text {
            flex: 1;
        }

        .pwa-install-title {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .pwa-install-description {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .pwa-install-actions {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-sm);
        }

        /* ===== VIDEO PLAYER OVERRIDES ===== */
        video::-webkit-media-controls {
            display: none !important;
        }

        video::-webkit-media-controls-panel {
            display: none !important;
        }

        video::-webkit-media-controls-play-button {
            display: none !important;
        }

        video::-webkit-media-controls-start-playback-button {
            display: none !important;
        }

        /* ===== RESPONSIVE ADJUSTMENTS ===== */
        @media (min-width: 768px) {
            .app-container {
                max-width: 500px;
                margin: 0 auto;
                box-shadow: var(--shadow-lg);
                border-radius: 0;
                overflow: hidden;
            }
        }

        @media (max-width: 320px) {
            .products-grid {
                grid-template-columns: 1fr;
            }
            
            .ride-type-selector {
                grid-template-columns: 1fr;
            }
            
            .nav-tab span {
                display: none;
            }
            
            .nav-tab i {
                font-size: 20px;
            }
        }

        /* ===== FULLSCREEN VIDEO STYLES ===== */
        .fullscreen-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .fullscreen-video.active {
            opacity: 1;
            pointer-events: all;
        }

        .fullscreen-video video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }

        .fullscreen-controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 30px;
            padding: 20px;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            z-index: 10000;
        }

        .fullscreen-control-btn {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid rgba(255, 255, 255, 0.4);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .fullscreen-control-btn:active {
            background: rgba(0, 0, 0, 0.9);
            border-color: var(--primary);
            transform: scale(0.95);
        }

        .close-fullscreen-btn {
            position: absolute;
            top: 40px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid rgba(255, 255, 255, 0.4);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            z-index: 10001;
            backdrop-filter: blur(10px);
        }

        .close-fullscreen-btn:active {
            background: rgba(0, 0, 0, 0.9);
            border-color: var(--danger);
            transform: scale(0.95);
        }

        /* ===== VIDEO NAVIGATION ===== */
        .video-nav-container {
            position: absolute;
            top: 50%;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            z-index: 10000;
            pointer-events: none;
        }

        .video-nav-btn {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid rgba(255, 255, 255, 0.4);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            pointer-events: all;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .video-nav-btn:active {
            background: rgba(0, 0, 0, 0.9);
            border-color: var(--primary);
            transform: scale(0.95);
        }

        .video-nav-btn.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        /* ===== REAL USER INDICATOR ===== */
        .real-user-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: linear-gradient(135deg, var(--success), #2ecc71);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 8px;
        }

        .admin-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: linear-gradient(135deg, var(--admin-color), #f39c12);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 8px;
        }

        .driver-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <!-- APP CONTAINER -->
    <div class="app-container">
        <!-- HEADER -->
        <header class="app-header">
            <div class="logo" onclick="showPage('home')">
                <div class="logo-icon">
                    <i class="fas fa-taxi"></i>
                </div>
                <div class="logo-text">VTC Mahajanga</div>
            </div>
            <div class="header-actions">
                <div class="notification-icon" onclick="showNotifications()">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge hidden" id="notification-badge">0</span>
                </div>
                <div class="cart-icon" onclick="showCartModal()">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count hidden" id="cart-count">0</span>
                </div>
                <div class="user-avatar" onclick="showPage('profile')" id="header-avatar">
                    👤
                </div>
            </div>
        </header>

        <!-- NAVIGATION -->
        <nav class="nav-tabs">
            <button class="nav-tab active" data-page="home">
                <i class="fas fa-home"></i>
                <span>Accueil</span>
            </button>
            <button class="nav-tab" data-page="ride">
                <i class="fas fa-car"></i>
                <span>Transport</span>
            </button>
            <button class="nav-tab" data-page="shop">
                <i class="fas fa-store"></i>
                <span>Boutique</span>
                <span class="nav-badge hidden" id="shop-badge">0</span>
            </button>
            <button class="nav-tab" data-page="map">
                <i class="fas fa-map"></i>
                <span>Carte</span>
            </button>
            <button class="nav-tab" data-page="social">
                <i class="fas fa-users"></i>
                <span>Social</span>
                <span class="nav-badge hidden" id="social-badge">3</span>
            </button>
            <button class="nav-tab messages-tab" data-page="messages" onclick="showPage('messages')">
                <i class="fas fa-comments"></i>
                <span>Messages</span>
                <span class="messages-nav-badge hidden" id="messages-nav-badge">0</span>
            </button>
        </nav>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <!-- PAGE ACCUEIL -->
            <div id="home-page" class="page active">
                <div class="page-content">
                    <!-- Bienvenue -->
                    <div class="card">
                        <div class="text-center mb-4">
                            <div class="profile-avatar-large mb-3">
                                <i class="fas fa-taxi"></i>
                            </div>
                            <h2>Bienvenue sur VTC Mahajanga</h2>
                            <p class="text-muted">Transport, Livraison & Réseau Social</p>
                        </div>

                        <div class="wallet-info">
                            <div class="wallet-label">SOLDE DISPONIBLE</div>
                            <div class="wallet-amount" id="home-wallet">0 Ar</div>
                            <button class="btn btn-shop mt-3" onclick="showAddMoneyModal()">
                                <i class="fas fa-plus-circle"></i>
                                Recharger le portefeuille
                            </button>
                        </div>
                    </div>

                    <!-- Services rapides -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-bolt"></i>
                                <span>Services rapides</span>
                            </div>
                        </div>
                        <div class="ride-type-selector">
                            <div class="ride-type" onclick="quickRide('car')">
                                <div class="ride-type-icon">
                                    <i class="fas fa-car"></i>
                                </div>
                                <div class="ride-type-name">Voiture</div>
                                <div class="ride-type-price">2 000 Ar/km</div>
                            </div>
                            <div class="ride-type" onclick="quickRide('tuktuk')">
                                <div class="ride-type-icon">
                                    <i class="fas fa-motorcycle"></i>
                                </div>
                                <div class="ride-type-name">TukTuk</div>
                                <div class="ride-type-price">1 500 Ar/km</div>
                            </div>
                            <div class="ride-type" onclick="showPage('shop')">
                                <div class="ride-type-icon">
                                    <i class="fas fa-shopping-bag"></i>
                                </div>
                                <div class="ride-type-name">Boutique</div>
                                <div class="ride-type-price">Livraison rapide</div>
                            </div>
                            <div class="ride-type" onclick="showPage('map')">
                                <div class="ride-type-icon">
                                    <i class="fas fa-map-marker-alt"></i>
                                </div>
                                <div class="ride-type-name">Carte Live</div>
                                <div class="ride-type-price">Suivi en temps réel</div>
                            </div>
                        </div>
                    </div>

                    <!-- Dernières commandes -->
                    <div class="card" id="recent-orders-section">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-history"></i>
                                <span>Dernières commandes</span>
                            </div>
                            <button class="btn btn-sm btn-primary" onclick="showPage('profile')">
                                Voir tout
                            </button>
                        </div>
                        <div id="recent-orders">
                            <!-- Commandes récentes -->
                        </div>
                    </div>

                    <!-- Actualités et Événements -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-bullhorn"></i>
                                <span>Actualités & Événements</span>
                            </div>
                            <button class="btn btn-sm btn-primary" onclick="showAllNews()">
                                Voir tout
                            </button>
                        </div>
                        
                        <div class="news-slider" id="news-slider">
                            <!-- Les actualités seront chargées ici -->
                        </div>
                    </div>

                    <!-- Publications récentes -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-newspaper"></i>
                                <span>Publications récentes</span>
                            </div>
                            <button class="btn btn-sm btn-primary" onclick="showPage('social')">
                                Voir tout
                            </button>
                        </div>
                        <div id="recent-posts-container">
                            <!-- Les publications récentes seront chargées ici -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE TRANSPORT -->
            <div id="ride-page" class="page">
                <div class="page-content">
                    <!-- Demande de course -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-car-side"></i>
                                <span>Demander une course</span>
                            </div>
                        </div>

                        <div class="input-group">
                            <label class="input-label">
                                <i class="fas fa-map-marker-alt"></i>
                                Point de départ
                            </label>
                            <div class="d-flex gap-2">
                                <input type="text" class="input-field flex-1" id="pickup-input" placeholder="Votre position actuelle" readonly>
                                <button class="btn btn-primary" style="width: auto; padding: 0 12px;" onclick="getCurrentLocation()">
                                    <i class="fas fa-location-crosshairs"></i>
                                </button>
                            </div>
                        </div>

                        <div class="input-group">
                            <label class="input-label">
                                <i class="fas fa-flag-checkered"></i>
                                Destination
                            </label>
                            <input type="text" class="input-field" id="destination-input" placeholder="Où allez-vous ?">
                        </div>

                        <!-- Type de véhicule -->
                        <div class="input-group">
                            <label class="input-label">
                                <i class="fas fa-car"></i>
                                Type de véhicule
                            </label>
                            <div class="ride-type-selector">
                                <div class="ride-type selected" data-type="car" onclick="selectRideType('car')">
                                    <div class="ride-type-icon">
                                        <i class="fas fa-car"></i>
                                    </div>
                                    <div class="ride-type-name">Voiture</div>
                                    <div class="ride-type-price">2 000 Ar/km</div>
                                </div>
                                <div class="ride-type" data-type="tuktuk" onclick="selectRideType('tuktuk')">
                                    <div class="ride-type-icon">
                                        <i class="fas fa-motorcycle"></i>
                                    </div>
                                    <div class="ride-type-name">TukTuk</div>
                                    <div class="ride-type-price">1 500 Ar/km</div>
                                </div>
                                <div class="ride-type" data-type="scooter" onclick="selectRideType('scooter')">
                                    <div class="ride-type-icon">
                                        <i class="fas fa-biking"></i>
                                    </div>
                                    <div class="ride-type-name">Scooter</div>
                                    <div class="ride-type-price">1 200 Ar/km</div>
                                </div>
                                <div class="ride-type" data-type="van" onclick="selectRideType('van')">
                                    <div class="ride-type-icon">
                                        <i class="fas fa-shuttle-van"></i>
                                    </div>
                                    <div class="ride-type-name">Van</div>
                                    <div class="ride-type-price">3 000 Ar/km</div>
                                </div>
                            </div>
                        </div>

                        <!-- Estimation -->
                        <div class="ride-estimate" id="ride-estimate">
                            <div class="text-muted">Estimation</div>
                            <div class="estimate-price" id="estimate-price">0 Ar</div>
                            <div class="estimate-time" id="estimate-time">0 min</div>
                        </div>

                        <button class="btn btn-primary" onclick="findDrivers()">
                            <i class="fas fa-search"></i>
                            Trouver un chauffeur
                        </button>
                    </div>

                    <!-- Chauffeurs disponibles -->
                    <div class="card" id="available-drivers-card" style="display: none;">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-users"></i>
                                <span>Chauffeurs disponibles</span>
                            </div>
                        </div>
                        <div id="available-drivers">
                            <!-- Chauffeurs -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE BOUTIQUE -->
            <div id="shop-page" class="page">
                <div class="page-content">
                    <!-- Catégorie Nourriture -->
                    <div class="shop-category">
                        <div class="category-title">
                            <i class="fas fa-utensils"></i> Nourriture & Boissons
                        </div>
                        <div class="products-grid" id="food-products">
                            <!-- Produits -->
                        </div>
                    </div>

                    <!-- Catégorie Accessoires -->
                    <div class="shop-category">
                        <div class="category-title">
                            <i class="fas fa-tshirt"></i> Accessoires VTC
                        </div>
                        <div class="products-grid" id="accessories-products">
                            <!-- Produits -->
                        </div>
                    </div>

                    <!-- Catégorie Partenaires -->
                    <div class="shop-category">
                        <div class="category-title partner">
                            <i class="fas fa-handshake"></i> Produits Partenaires
                        </div>
                        <div class="products-grid" id="partner-products">
                            <!-- Produits partenaires -->
                        </div>
                    </div>

                    <!-- Panier -->
                    <div class="card" id="cart-section">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-shopping-cart"></i>
                                <span>Votre Panier</span>
                            </div>
                        </div>
                        <div id="cart-items">
                            <div class="text-center text-muted p-4" id="empty-cart-message">
                                <i class="fas fa-shopping-cart" style="font-size: 36px; margin-bottom: var(--space-sm);"></i>
                                <div>Votre panier est vide</div>
                            </div>
                        </div>
                        
                        <div class="order-summary hidden" id="order-summary">
                            <div class="summary-item">
                                <span>Sous-total:</span>
                                <span id="subtotal">0 Ar</span>
                            </div>
                            <div class="summary-item">
                                <span>Livraison:</span>
                                <span id="delivery-cost">0 Ar</span>
                            </div>
                            <div class="summary-total">
                                <span>Total:</span>
                                <span id="total-cost">0 Ar</span>
                            </div>
                            
                            <button class="btn btn-shop btn-block mt-3" onclick="checkout()">
                                <i class="fas fa-credit-card"></i>
                                Commander maintenant
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE CARTE -->
            <div id="map-page" class="page">
                <div class="page-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-map-marked-alt"></i>
                                <span>Carte Live - VTC Mahajanga</span>
                            </div>
                            <button class="btn btn-sm btn-primary" id="refresh-map-btn">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        
                        <div class="map-container">
                            <div id="map"></div>
                            <div class="map-controls">
                                <button class="map-control-btn" id="locate-me-btn" title="Me localiser">
                                    <i class="fas fa-location-crosshairs"></i>
                                </button>
                                <button class="map-control-btn" id="center-mj-btn" title="Centrer Mahajanga">
                                    <i class="fas fa-map-marker-alt"></i>
                                </button>
                                <button class="map-control-btn" id="toggle-radius-btn" title="Afficher/Masquer le cercle">
                                    <i class="fas fa-circle"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="text-center mt-3">
                            <div class="text-muted d-flex align-items-center justify-content-center gap-2">
                                <i class="fas fa-info-circle"></i>
                                <span style="font-size: 12px;">Cercle bleu = Zone de 3km autour de vous</span>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-users"></i>
                                <span>Chauffeurs à proximité (3km)</span>
                                <span id="drivers-count" class="text-muted">0 en ligne</span>
                            </div>
                        </div>
                        <div id="drivers-list">
                            <!-- Chauffeurs -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE RÉSEAU SOCIAL -->
            <div id="social-page" class="page">
                <div class="page-content">
                    <!-- Créer une publication -->
                    <div class="create-post">
                        <div class="create-post-header">
                            <div class="user-avatar" id="current-user-avatar">👤</div>
                            <input type="text" 
                                   class="post-input" 
                                   placeholder="Quoi de neuf ? Partagez vos moments..."
                                   id="post-text-input">
                        </div>
                        
                        <div class="media-preview" id="media-preview">
                            <!-- Aperçu média -->
                        </div>
                        
                        <div class="post-options">
                            <div class="post-option" onclick="document.getElementById('media-input').click()">
                                <i class="fas fa-image"></i>
                                <span>Photo/Video</span>
                            </div>
                            <div class="post-option" onclick="showLocationPicker()">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>Localisation</span>
                            </div>
                            <div class="post-option" onclick="tagFriends()">
                                <i class="fas fa-tag"></i>
                                <span>Tagger</span>
                            </div>
                        </div>
                        
                        <input type="file" 
                               id="media-input" 
                               class="hidden" 
                               accept="image/*,video/*" 
                               multiple 
                               onchange="handleMediaUpload(event)">
                        
                        <button class="btn btn-primary btn-block mt-3" id="publish-post-btn" onclick="createPost()">
                            <i class="fas fa-paper-plane"></i>
                            Publier
                        </button>
                    </div>

                    <!-- Publications -->
                    <div id="posts-container">
                        <!-- Posts -->
                    </div>
                </div>
            </div>

            <!-- PAGE MESSAGES -->
            <div id="messages-page" class="page">
                <div class="page-content">
                    <!-- En-tête Messages -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-comments"></i>
                                <span>Messages</span>
                            </div>
                            <button class="btn btn-sm btn-primary" onclick="startNewConversation()">
                                <i class="fas fa-plus"></i>
                                Nouveau
                            </button>
                        </div>
                    </div>

                    <!-- Liste des conversations -->
                    <div class="card">
                        <div class="conversations-list" id="conversations-list">
                            <!-- Conversations -->
                        </div>
                    </div>

                    <!-- Suggestions d'amis pour discuter -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-user-friends"></i>
                                <span>Suggestions</span>
                            </div>
                        </div>
                        <div id="suggested-users">
                            <!-- Suggestions -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE PROFIL -->
            <div id="profile-page" class="page">
                <div class="page-content">
                    <!-- Connexion/Inscription -->
                    <div id="auth-section">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-user-circle"></i>
                                    <span>Connexion à VTC Mahajanga</span>
                                </div>
                            </div>

                            <div class="input-group">
                                <label class="input-label">
                                    <i class="fas fa-user-tag"></i>
                                    Je suis
                                </label>
                                <select id="auth-role" class="input-field">
                                    <option value="passenger">👤 Passager</option>
                                    <option value="driver">🚗 Chauffeur</option>
                                    <option value="admin">👑 Administrateur</option>
                                </select>
                            </div>

                            <div class="input-group">
                                <label class="input-label">
                                    <i class="fas fa-envelope"></i>
                                    Email
                                </label>
                                <input type="email" 
                                       id="auth-email" 
                                       class="input-field"
                                       placeholder="votre@email.com">
                            </div>

                            <div class="input-group">
                                <label class="input-label">
                                    <i class="fas fa-lock"></i>
                                    Mot de passe
                                </label>
                                <input type="password" 
                                       id="auth-password" 
                                       class="input-field"
                                       placeholder="Votre mot de passe">
                            </div>

                            <div class="input-group" id="driver-license-field" style="display: none;">
                                <label class="input-label">
                                    <i class="fas fa-id-card"></i>
                                    Numéro de permis
                                </label>
                                <input type="text" 
                                       id="auth-license" 
                                       class="input-field"
                                       placeholder="Numéro de permis de conduire">
                            </div>

                            <button class="btn btn-primary btn-block mb-2" id="auth-btn">
                                <i class="fas fa-sign-in-alt"></i>
                                Se connecter
                            </button>

                            <button class="btn btn-block" style="background: rgba(255, 255, 255, 0.08); color: var(--text);" id="toggle-auth-mode">
                                <span>Créer un compte</span>
                            </button>
                        </div>
                    </div>

                    <!-- Profil -->
                    <div id="profile-section" class="hidden">
                        <div class="profile-header">
                            <div class="profile-avatar-large" id="profile-avatar" onclick="changeAvatar()">
                                👤
                                <div class="avatar-edit-overlay">
                                    <i class="fas fa-camera"></i> Changer
                                </div>
                            </div>
                            <h2 id="profile-name">Utilisateur</h2>
                            <div class="text-muted" id="profile-bio">Membre VTC Mahajanga</div>
                            
                            <div class="wallet-info">
                                <div class="wallet-label">SOLDE DU PORTEFEUILLE</div>
                                <div class="wallet-amount" id="profile-wallet">0 Ar</div>
                                <button class="btn btn-shop mt-3" onclick="showAddMoneyModal()">
                                    <i class="fas fa-money-bill-wave"></i>
                                    Ajouter des fonds
                                </button>
                            </div>
                            
                            <div class="profile-stats">
                                <div class="stat-item" onclick="showUserPosts()">
                                    <div class="stat-number" id="posts-count">0</div>
                                    <div class="stat-label">Publications</div>
                                </div>
                                <div class="stat-item" onclick="showFollowers()">
                                    <div class="stat-number" id="followers-count">0</div>
                                    <div class="stat-label">Abonnés</div>
                                </div>
                                <div class="stat-item" onclick="showOrderHistory()">
                                    <div class="stat-number" id="orders-count">0</div>
                                    <div class="stat-label">Commandes</div>
                                </div>
                                <div class="stat-item" onclick="showPage('messages')">
                                    <div class="stat-number" id="messages-count">0</div>
                                    <div class="stat-label">Messages</div>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary mt-3" onclick="editProfile()">
                                <i class="fas fa-edit"></i>
                                Modifier le profil
                            </button>
                            
                            <!-- Bouton Admin -->
                            <button class="btn btn-admin mt-2 hidden" id="admin-btn" onclick="showAdminPanel()">
                                <i class="fas fa-crown"></i>
                                Panel Administrateur
                            </button>
                            
                            <button class="btn btn-danger mt-2" onclick="logout()">
                                <i class="fas fa-sign-out-alt"></i>
                                Se déconnecter
                            </button>
                        </div>

                        <!-- Historique des commandes -->
                        <div class="card order-history" id="order-history-section">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-history"></i>
                                    <span>Historique des Commandes</span>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="refreshOrders()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            <div id="orders-container">
                                <!-- Commandes -->
                                <div class="text-center text-muted p-4">
                                    <i class="fas fa-history" style="font-size: 36px; margin-bottom: var(--space-sm);"></i>
                                    <div>Aucune commande passée</div>
                                </div>
                            </div>
                        </div>

                        <!-- Panel Administrateur -->
                        <div class="admin-panel hidden" id="admin-panel">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-crown"></i>
                                    <span>Panel Administrateur</span>
                                </div>
                                <button class="btn btn-sm btn-admin" onclick="refreshAdminData()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>

                            <div class="admin-nav">
                                <div class="admin-tab active" onclick="showAdminTab('dashboard')">
                                    <i class="fas fa-chart-bar"></i>
                                    Tableau de bord
                                </div>
                                <div class="admin-tab" onclick="showAdminTab('users')">
                                    <i class="fas fa-users"></i>
                                    Utilisateurs
                                </div>
                                <div class="admin-tab" onclick="showAdminTab('drivers')">
                                    <i class="fas fa-car"></i>
                                    Chauffeurs
                                </div>
                                <div class="admin-tab" onclick="showAdminTab('orders')">
                                    <i class="fas fa-shopping-cart"></i>
                                    Commandes
                                </div>
                                <div class="admin-tab" onclick="showAdminTab('posts')">
                                    <i class="fas fa-newspaper"></i>
                                    Publications
                                </div>
                                <div class="admin-tab" onclick="showAdminTab('messages')">
                                    <i class="fas fa-comments"></i>
                                    Messages
                                </div>
                            </div>

                            <!-- Dashboard -->
                            <div class="admin-section active" id="admin-dashboard">
                                <div class="stats-grid">
                                    <div class="stat-card">
                                        <div class="stat-number" id="admin-total-users">0</div>
                                        <div class="stat-label">Utilisateurs</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-number" id="admin-total-drivers">0</div>
                                        <div class="stat-label">Chauffeurs</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-number" id="admin-total-orders">0</div>
                                        <div class="stat-label">Commandes</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-number" id="admin-total-posts">0</div>
                                        <div class="stat-label">Publications</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-number" id="admin-total-messages">0</div>
                                        <div class="stat-label">Messages</div>
                                    </div>
                                </div>

                                <div class="card mt-3">
                                    <div class="card-header">
                                        <div class="card-title">
                                            <i class="fas fa-chart-line"></i>
                                            <span>Statistiques récentes</span>
                                        </div>
                                    </div>
                                    <div class="p-3">
                                        <div class="text-muted mb-2">Commandes aujourd'hui: <span id="admin-today-orders">0</span></div>
                                        <div class="text-muted mb-2">Revenus aujourd'hui: <span id="admin-today-revenue">0 Ar</span></div>
                                        <div class="text-muted">Utilisateurs actifs: <span id="admin-active-users">0</span></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Gestion Utilisateurs -->
                            <div class="admin-section" id="admin-users">
                                <input type="text" 
                                       class="input-field mb-3" 
                                       placeholder="Rechercher un utilisateur..."
                                       oninput="searchUsers(this.value)">
                                <div style="max-height: 300px; overflow-y: auto;">
                                    <table class="admin-table">
                                        <thead>
                                            <tr>
                                                <th>Nom</th>
                                                <th>Email</th>
                                                <th>Type</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="admin-users-table">
                                            <!-- Utilisateurs -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Gestion Chauffeurs -->
                            <div class="admin-section" id="admin-drivers">
                                <div style="max-height: 300px; overflow-y: auto;">
                                    <table class="admin-table">
                                        <thead>
                                            <tr>
                                                <th>Nom</th>
                                                <th>Véhicule</th>
                                                <th>Note</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="admin-drivers-table">
                                            <!-- Chauffeurs -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Gestion Commandes -->
                            <div class="admin-section" id="admin-orders">
                                <div style="max-height: 300px; overflow-y: auto;">
                                    <table class="admin-table">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Type</th>
                                                <th>Montant</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="admin-orders-table">
                                            <!-- Commandes -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Gestion Publications -->
                            <div class="admin-section" id="admin-posts">
                                <div style="max-height: 300px; overflow-y: auto;">
                                    <table class="admin-table">
                                        <thead>
                                            <tr>
                                                <th>Auteur</th>
                                                <th>Contenu</th>
                                                <th>Likes</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="admin-posts-table">
                                            <!-- Publications -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Gestion Messages -->
                            <div class="admin-section" id="admin-messages">
                                <div style="max-height: 300px; overflow-y: auto;">
                                    <table class="admin-table">
                                        <thead>
                                            <tr>
                                                <th>De</th>
                                                <th>À</th>
                                                <th>Message</th>
                                                <th>Heure</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="admin-messages-table">
                                            <!-- Messages -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- SUIVI DE COURSE -->
    <div id="ride-tracking" class="ride-tracking hidden">
        <div class="ride-info">
            <div class="ride-driver-avatar" id="tracking-driver-avatar">
                🚗
            </div>
            <div class="ride-driver-info">
                <div class="ride-driver-name" id="tracking-driver-name">Chauffeur</div>
                <div class="ride-vehicle" id="tracking-vehicle">Voiture • Plaque</div>
            </div>
            <div class="driver-price" id="tracking-price">0 Ar</div>
        </div>
        
        <div class="ride-progress">
            <div class="progress-bar">
                <div class="progress-fill" id="ride-progress-fill"></div>
            </div>
        </div>
        
        <div class="ride-actions">
            <button class="ride-action-btn call" onclick="callDriver()">
                <i class="fas fa-phone"></i>
                Appeler
            </button>
            <button class="ride-action-btn message" onclick="openMessages()">
                <i class="fas fa-comment"></i>
                Message
            </button>
            <button class="ride-action-btn cancel" onclick="cancelRide()">
                <i class="fas fa-times"></i>
                Annuler
            </button>
        </div>
    </div>

    <!-- MESSAGES MODAL -->
    <div id="messages-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="card-title">
                    <i class="fas fa-comments"></i>
                    <span id="messages-modal-title">Messages</span>
                </div>
                <button class="modal-close" onclick="closeMessagesModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="messages-container">
                <div class="messages-list" id="messages-list">
                    <!-- Messages -->
                </div>
            </div>
            
            <div class="message-input-container">
                <input type="text" class="message-input" id="message-input" placeholder="Tapez votre message..." onkeypress="if(event.key === 'Enter') sendMessage()">
                <button class="message-send-btn" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL NOUVELLE CONVERSATION -->
    <div id="new-conversation-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="card-title">
                    <i class="fas fa-user-plus"></i>
                    <span>Nouvelle conversation</span>
                </div>
                <button class="modal-close" onclick="closeNewConversationModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="input-group">
                <label class="input-label">
                    <i class="fas fa-search"></i>
                    Rechercher un utilisateur
                </label>
                <input type="text" 
                       class="input-field" 
                       id="search-user-input"
                       placeholder="Nom, email ou @username"
                       oninput="searchUsersForMessage(this.value)">
            </div>

            <div class="conversations-list" id="search-users-results" style="max-height: 300px; overflow-y: auto; margin-top: var(--space-md);">
                <!-- Résultats de recherche -->
            </div>
        </div>
    </div>

    <!-- MODAL PANIER -->
    <div id="cart-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="card-title">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Votre Panier</span>
                </div>
                <button class="modal-close" onclick="closeCartModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="modal-cart-items" style="max-height: 300px; overflow-y: auto; margin: var(--space-md) 0;">
                <!-- Articles -->
            </div>
            
            <div class="order-summary">
                <div class="summary-item">
                    <span>Sous-total:</span>
                    <span id="modal-subtotal">0 Ar</span>
                </div>
                <div class="summary-item">
                    <span>Livraison:</span>
                    <span id="modal-delivery">0 Ar</span>
                </div>
                <div class="summary-total">
                    <span>Total:</span>
                    <span id="modal-total">0 Ar</span>
                </div>
            </div>
            
            <button class="btn btn-shop btn-block mt-3" onclick="goToCheckout()">
                <i class="fas fa-credit-card"></i>
                Passer la commande
            </button>
        </div>
    </div>

    <!-- MODAL AJOUTER DE L'ARGENT -->
    <div id="add-money-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="card-title">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Ajouter des fonds</span>
                </div>
                <button class="modal-close" onclick="closeAddMoneyModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="input-group">
                <label class="input-label">
                    <i class="fas fa-coins"></i>
                    Montant à ajouter (Ar)
                </label>
                <input type="number" 
                       id="add-money-amount" 
                       class="input-field"
                       min="1000" 
                       step="1000"
                       placeholder="Ex: 10000"
                       style="font-size: 20px; text-align: center;">
            </div>

            <div class="input-group">
                <label class="input-label">
                    <i class="fas fa-credit-card"></i>
                    Méthode de paiement
                </label>
                <select id="payment-method" class="input-field">
                    <option value="mvola">Mvola</option>
                    <option value="airtel">Airtel Money</option>
                    <option value="orange">Orange Money</option>
                    <option value="bank">Carte bancaire</option>
                </select>
            </div>

            <button class="btn btn-success btn-block mt-3" onclick="addMoneyToWallet()">
                <i class="fas fa-check-circle"></i>
                Confirmer l'ajout
            </button>
        </div>
    </div>

    <!-- MODAL NOTIFICATIONS -->
    <div id="notifications-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="card-title">
                    <i class="fas fa-bell"></i>
                    <span>Notifications</span>
                </div>
                <button class="modal-close" onclick="closeNotificationsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="notifications-list" style="max-height: 400px; overflow-y: auto;">
                <!-- Notifications -->
                <div class="text-center text-muted p-4">
                    <i class="fas fa-bell-slash" style="font-size: 36px; margin-bottom: var(--space-sm);"></i>
                    <div>Aucune notification</div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL CONFIRMATION COMMANDE -->
    <div id="checkout-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="card-title">
                    <i class="fas fa-check-circle"></i>
                    <span>Commande confirmée !</span>
                </div>
            </div>
            
            <div class="text-center mb-4">
                <div class="profile-avatar-large" style="width: 80px; height: 80px; font-size: 32px; margin: 0 auto var(--space-md);">
                    <i class="fas fa-check"></i>
                </div>
                <h3>Commande confirmée !</h3>
                <div class="text-muted">Votre commande a été enregistrée</div>
            </div>

            <div class="order-summary">
                <div class="summary-item">
                    <span>Numéro:</span>
                    <span id="order-number">#0000</span>
                </div>
                <div class="summary-item">
                    <span>Date:</span>
                    <span id="order-date">--/--/----</span>
                </div>
                <div class="summary-item">
                    <span>Livraison:</span>
                    <span id="order-address">--</span>
                </div>
                <div class="summary-total">
                    <span>Total payé:</span>
                    <span id="order-total">0 Ar</span>
                </div>
            </div>

            <div class="mt-4 text-center">
                <div class="text-muted" style="font-size: 14px;">
                    <i class="fas fa-clock"></i> Temps estimé: <span id="delivery-time">20-30 minutes</span>
                </div>
            </div>

            <button class="btn btn-success btn-block mt-4" onclick="closeCheckoutModal()">
                <i class="fas fa-home"></i>
                Retour à l'accueil
            </button>
        </div>
    </div>

    <!-- MODAL PROFIL UTILISATEUR -->
    <div id="user-profile-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="card-title">
                    <i class="fas fa-user"></i>
                    <span id="modal-user-name">Profil</span>
                </div>
                <button class="modal-close" onclick="closeUserProfileModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="profile-header">
                <div class="profile-avatar-large" id="modal-user-avatar">👤</div>
                <h2 id="modal-user-fullname">Utilisateur</h2>
                <div class="text-muted" id="modal-user-bio">Bio utilisateur</div>
                
                <div class="profile-stats">
                    <div class="stat-item">
                        <div class="stat-number" id="modal-posts-count">0</div>
                        <div class="stat-label">Publications</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="modal-followers-count">0</div>
                        <div class="stat-label">Abonnés</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="modal-following-count">0</div>
                        <div class="stat-label">Abonnements</div>
                    </div>
                </div>
                
                <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-primary flex-1" id="follow-btn" onclick="toggleFollow()">
                        <i class="fas fa-user-plus"></i>
                        S'abonner
                    </button>
                    <button class="btn btn-success flex-1" onclick="sendMessageToUser()">
                        <i class="fas fa-comment"></i>
                        Message
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL ÉDITION PROFIL -->
    <div id="edit-profile-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="card-title">
                    <i class="fas fa-edit"></i>
                    <span>Modifier le profil</span>
                </div>
                <button class="modal-close" onclick="closeEditProfileModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="input-group">
                <label class="input-label">
                    <i class="fas fa-user"></i>
                    Nom complet
                </label>
                <input type="text" 
                       id="edit-name-input" 
                       class="input-field">
            </div>

            <div class="input-group">
                <label class="input-label">
                    <i class="fas fa-phone"></i>
                    Téléphone
                </label>
                <input type="tel" 
                       id="edit-phone-input" 
                       class="input-field"
                       placeholder="+261 34 XX XX XX">
            </div>

            <div class="input-group">
                <label class="input-label">
                    <i class="fas fa-quote-left"></i>
                    Bio
                </label>
                <textarea id="edit-bio-input" 
                          class="input-field"
                          rows="3"
                          placeholder="Parlez-nous de vous..."></textarea>
            </div>

            <div class="input-group">
                <label class="input-label">
                    <i class="fas fa-image"></i>
                    Photo de profil
                </label>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary flex-1" onclick="document.getElementById('avatar-input').click()">
                        <i class="fas fa-upload"></i>
                        Changer la photo
                    </button>
                    <input type="file" 
                           id="avatar-input" 
                           class="hidden" 
                           accept="image/*"
                           onchange="handleAvatarUpload(event)">
                </div>
            </div>

            <button class="btn btn-success btn-block mt-3" onclick="saveProfileChanges()">
                <i class="fas fa-save"></i>
                Enregistrer
            </button>
        </div>
    </div>

    <!-- MODAL INSCRIPTION CHAUFFEUR -->
    <div id="driver-registration-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="card-title">
                    <i class="fas fa-id-card"></i>
                    <span>Inscription Chauffeur</span>
                </div>
                <button class="modal-close" onclick="closeDriverRegistration()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="input-group">
                <label class="input-label">
                    <i class="fas fa-user"></i>
                    Nom complet
                </label>
                <input type="text" 
                       id="driver-name" 
                       class="input-field"
                       placeholder="Votre nom complet">
            </div>

            <div class="input-group">
                <label class="input-label">
                    <i class="fas fa-envelope"></i>
                    Email
                </label>
                <input type="email" 
                       id="driver-email" 
                       class="input-field"
                       placeholder="votre@email.com">
            </div>

            <div class="input-group">
                <label class="input-label">
                    <i class="fas fa-phone"></i>
                    Téléphone
                </label>
                <input type="tel" 
                       id="driver-phone" 
                       class="input-field"
                       placeholder="+261 34 XX XX XX">
            </div>

            <div class="input-group">
                <label class="input-label">
                    <i class="fas fa-id-card"></i>
                    Numéro de permis
                </label>
                <input type="text" 
                       id="driver-license" 
                       class="input-field"
                       placeholder="Ex: 1234567890"
                       maxlength="20">
                <div class="text-muted" style="font-size: 11px; margin-top: 4px;">
                    Format: 10 chiffres minimum
                </div>
            </div>

            <div class="input-group">
                <label class="input-label">
                    <i class="fas fa-car"></i>
                    Véhicule
                </label>
                <input type="text" 
                       id="driver-vehicle" 
                       class="input-field"
                       placeholder="Marque, modèle, année">
            </div>

            <div class="input-group">
                <label class="input-label">
                    <i class="fas fa-hashtag"></i>
                    Plaque d'immatriculation
                </label>
                <input type="text" 
                       id="driver-plate" 
                       class="input-field"
                       placeholder="Ex: AB 1234 TD">
            </div>

            <div class="input-group">
                <label class="input-label">
                    <i class="fas fa-lock"></i>
                    Mot de passe
                </label>
                <input type="password" 
                       id="driver-password" 
                       class="input-field"
                       placeholder="Minimum 6 caractères">
            </div>

            <div class="input-group">
                <label class="input-label">
                    <i class="fas fa-lock"></i>
                    Confirmer le mot de passe
                </label>
                <input type="password" 
                       id="driver-confirm-password" 
                       class="input-field"
                       placeholder="Répétez le mot de passe">
            </div>

            <button class="btn btn-success btn-block mt-3" onclick="registerDriver()">
                <i class="fas fa-user-plus"></i>
                S'inscrire comme chauffeur
            </button>
        </div>
    </div>

    <!-- MODAL RAPPORT -->
    <div id="report-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="card-title">
                    <i class="fas fa-flag"></i>
                    <span>Signaler</span>
                </div>
                <button class="modal-close" onclick="closeReportModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="input-group">
                <label class="input-label">
                    Raison du signalement
                </label>
                <select id="report-reason" class="input-field">
                    <option value="spam">Spam</option>
                    <option value="inappropriate">Contenu inapproprié</option>
                    <option value="harassment">Harcèlement</option>
                    <option value="violence">Violence</option>
                    <option value="false_info">Fausse information</option>
                    <option value="other">Autre</option>
                </select>
            </div>

            <div class="input-group">
                <label class="input-label">
                    <i class="fas fa-comment"></i>
                    Description
                </label>
                <textarea id="report-description" 
                          class="input-field"
                          rows="3"
                          placeholder="Décrivez le problème..."></textarea>
            </div>

            <button class="btn btn-danger btn-block mt-3" onclick="submitReport()">
                <i class="fas fa-paper-plane"></i>
                Signaler
            </button>
        </div>
    </div>

    <!-- MODAL DÉTAILS ACTUALITÉS -->
    <div id="news-detail-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="card-title">
                    <i class="fas fa-newspaper"></i>
                    <span id="news-modal-title">Actualité</span>
                </div>
                <button class="modal-close" onclick="closeNewsDetailModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="news-detail-content">
                <!-- Contenu de l'actualité -->
            </div>
        </div>
    </div>

    <!-- MODAL DÉTAILS PRODUIT PARTENAIRE -->
    <div id="partner-product-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="card-title">
                    <i class="fas fa-handshake"></i>
                    <span id="partner-product-title">Produit Partenaire</span>
                </div>
                <button class="modal-close" onclick="closePartnerProductModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="partner-product-content">
                <!-- Détails du produit partenaire -->
            </div>
        </div>
    </div>

    <!-- MODAL ADMIN -->
    <div id="admin-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="card-title">
                    <i class="fas fa-crown"></i>
                    <span id="admin-modal-title">Administration</span>
                </div>
                <button class="modal-close" onclick="closeAdminModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="admin-modal-content">
                <!-- Contenu admin -->
            </div>
        </div>
    </div>

    <!-- PWA INSTALL PROMPT -->
    <div id="pwa-install-prompt" class="pwa-install-prompt hidden">
        <div class="pwa-install-content">
            <div class="pwa-install-icon">
                <i class="fas fa-download"></i>
            </div>
            <div class="pwa-install-text">
                <div class="pwa-install-title">Installer VTC Mahajanga</div>
                <div class="pwa-install-description">Installez l'application pour une meilleure expérience</div>
            </div>
        </div>
        <div class="pwa-install-actions">
            <button class="btn btn-primary flex-1" onclick="installPWA()">
                <i class="fas fa-download"></i>
                Installer
            </button>
            <button class="btn flex-1" style="background: rgba(255, 255, 255, 0.08);" onclick="hidePWAInstallPrompt()">
                Plus tard
            </button>
        </div>
    </div>

    <!-- FULLSCREEN VIDEO PLAYER -->
    <div id="fullscreen-video" class="fullscreen-video">
        <video id="fullscreen-video-player" controls playsinline>
            Votre navigateur ne supporte pas la vidéo.
        </video>
        <div class="video-nav-container">
            <button class="video-nav-btn" id="prev-video-btn" onclick="showPreviousVideo()">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="video-nav-btn" id="next-video-btn" onclick="showNextVideo()">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        <div class="fullscreen-controls">
            <button class="fullscreen-control-btn" onclick="toggleFullscreenVideoPlay()">
                <i class="fas fa-play" id="fullscreen-play-icon"></i>
            </button>
            <button class="fullscreen-control-btn" onclick="toggleFullscreenVideoMute()">
                <i class="fas fa-volume-up" id="fullscreen-volume-icon"></i>
            </button>
        </div>
        <button class="close-fullscreen-btn" onclick="closeFullscreenVideo()">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- SCRIPTS -->

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script>
        // ===== CONFIGURATION =====
        const CONFIG = {
            MAHAJANGA_CENTER: [-15.7167, 46.3167],
            MAP_ZOOM: 14,
            PRICE_RATES: {
                car: 2000,
                tuktuk: 1500,
                scooter: 1200,
                van: 3000
            },
            DELIVERY_RATES: {
                base_fee: 2000,
                per_km: 1000,
                service_fee: 500,
                min_order: 5000
            },
            SHOP_CATEGORIES: {
                food: 'Nourriture',
                accessories: 'Accessoires',
                partners: 'Partenaires'
            },
            ADMIN_CREDENTIALS: {
                email: "admin@vtc401.com",
                password: "Admin401!"
            },
            USER_RADIUS_KM: 3,
            MAX_POSTS_HOME: 5
        };

        // ===== ÉTAT GLOBAL =====
        const AppState = {
            map: null,
            user: null,
            drivers: [],
            userMarker: null,
            driverMarkers: [],
            posts: [],
            users: [],
            currentUser: null,
            cart: [],
            wallet: 0,
            orders: [],
            products: [],
            notifications: [],
            news: [],
            selectedPostId: null,
            reportedPostId: null,
            deliveryPrice: 0,
            deliveryDistance: 0,
            selectedRideType: 'car',
            currentLocation: null,
            currentDriver: null,
            rideInProgress: false,
            currentRide: null,
            messages: [],
            deferredPrompt: null,
            isInstalled: false,
            uploadedMedia: [],
            driverMode: false,
            videoPlayers: new Map(),
            isAdmin: false,
            adminData: {
                users: [],
                drivers: [],
                orders: [],
                posts: [],
                messages: [],
                stats: {
                    totalUsers: 0,
                    totalDrivers: 0,
                    totalOrders: 0,
                    totalPosts: 0,
                    totalMessages: 0,
                    todayOrders: 0,
                    todayRevenue: 0,
                    activeUsers: 0
                }
            },
            conversations: [],
            currentConversation: null,
            unreadMessages: 0,
            userRadiusCircle: null,
            radiusVisible: true,
            isPosting: false,
            lastPostTime: 0,
            POST_COOLDOWN: 3000,
            // Variables pour les vidéos en plein écran
            fullscreenVideoIndex: -1,
            currentVideoPostId: null,
            fullscreenVideoIsPlaying: false,
            fullscreenVideoIsMuted: false
        };

        // ===== DONNÉES SIMULÉES =====
        const SAMPLE_PRODUCTS = [
            {
                id: 1,
                name: "Pizza VTC",
                description: "Pizza grande avec tous les ingrédients",
                price: 15000,
                category: 'food',
                image: '🍕',
                rating: 4.5,
                featured: true,
                preparationTime: 20,
                stock: 50,
                partner: null
            },
            {
                id: 2,
                name: "Burger Mahajanga",
                description: "Burger avec viande locale et frites",
                price: 12000,
                category: 'food',
                image: '🍔',
                rating: 4.3,
                featured: false,
                preparationTime: 15,
                stock: 30,
                partner: null
            },
            {
                id: 3,
                name: "Salade Fraîche",
                description: "Salade composée avec légumes frais",
                price: 8000,
                category: 'food',
                image: '🥗',
                rating: 4.2,
                featured: false,
                preparationTime: 10,
                stock: 25,
                partner: null
            },
            {
                id: 4,
                name: "Café Premium",
                description: "Café arabica de qualité supérieure",
                price: 3000,
                category: 'food',
                image: '☕',
                rating: 4.7,
                featured: true,
                preparationTime: 5,
                stock: 100,
                partner: null
            },
            {
                id: 5,
                name: "Chargeur USB Voiture",
                description: "Chargeur rapide 2 ports pour voiture",
                price: 25000,
                category: 'accessories',
                image: '🔌',
                rating: 4.6,
                featured: true,
                preparationTime: 0,
                stock: 20,
                partner: null
            },
            {
                id: 6,
                name: "Support Téléphone",
                description: "Support pour GPS et téléphone",
                price: 15000,
                category: 'accessories',
                image: '📱',
                rating: 4.3,
                featured: false,
                preparationTime: 0,
                stock: 35,
                partner: null
            },
            {
                id: 7,
                name: "Pack Partenaire Gold",
                description: "Abonnement premium avec avantages exclusifs",
                price: 50000,
                category: 'partners',
                image: '🏆',
                rating: 4.9,
                featured: true,
                preparationTime: 0,
                stock: 100,
                partner: "VTC Mahajanga",
                benefits: [
                    "10% de réduction sur toutes les courses",
                    "Livraison gratuite",
                    "Support prioritaire",
                    "Accès aux événements exclusifs"
                ]
            },
            {
                id: 8,
                name: "Formation Chauffeur Pro",
                description: "Formation certifiée pour chauffeurs VTC",
                price: 150000,
                category: 'partners',
                image: '📚',
                rating: 4.8,
                featured: true,
                preparationTime: 0,
                stock: 50,
                partner: "Académie VTC",
                benefits: [
                    "Certification reconnue",
                    "Support après formation",
                    "Accès à la communauté",
                    "Placement garanti"
                ]
            },
            {
                id: 9,
                name: "Assurance Véhicule",
                description: "Assurance tous risques pour chauffeurs",
                price: 300000,
                category: 'partners',
                image: '🛡️',
                rating: 4.7,
                featured: false,
                preparationTime: 0,
                stock: 30,
                partner: "AssurMad",
                benefits: [
                    "Couverture complète",
                    "Assistance 24/7",
                    "Dépannage rapide",
                    "Garantie à l'étranger"
                ]
            }
        ];

        const SAMPLE_DRIVERS = [
            { 
                id: 1, 
                name: "Jean Rakoto", 
                vehicle: "Toyota Corolla 2022", 
                plate: "AB 1234 TD",
                rating: 4.8, 
                lat: -15.718, 
                lng: 46.316,
                status: 'available',
                phone: "+261 34 11 111 11",
                photo: '👨',
                type: 'car',
                priceMultiplier: 1.0,
                distance: 1.2,
                eta: 5,
                color: '#007AFF'
            },
            { 
                id: 2, 
                name: "Paul Randria", 
                vehicle: "TukTuk 3 roues", 
                plate: "CD 5678 TD",
                rating: 4.6, 
                lat: -15.715, 
                lng: 46.314,
                status: 'available',
                phone: "+261 34 22 222 22",
                photo: '👨',
                type: 'tuktuk',
                priceMultiplier: 0.9,
                distance: 2.1,
                eta: 8,
                color: '#FF9500'
            },
            { 
                id: 3, 
                name: "Marie Ravao", 
                vehicle: "Scooter Yamaha", 
                plate: "EF 9012 TD",
                rating: 4.9, 
                lat: -15.720, 
                lng: 46.318,
                status: 'available',
                phone: "+261 34 33 333 33",
                photo: '👩',
                type: 'scooter',
                priceMultiplier: 0.8,
                distance: 3.5,
                eta: 12,
                color: '#34C759'
            },
            { 
                id: 4, 
                name: "Robert Andria", 
                vehicle: "Toyota Hiace 2020", 
                plate: "GH 3456 TD",
                rating: 4.7, 
                lat: -15.712, 
                lng: 46.320,
                status: 'available',
                phone: "+261 34 44 444 44",
                photo: '👨',
                type: 'van',
                priceMultiplier: 1.5,
                distance: 1.8,
                eta: 7,
                color: '#5856D6'
            }
        ];

        const SAMPLE_USERS = [
            {
                id: 1,
                name: "Rakoto Jean",
                username: "rakoto_jean",
                email: "jean@example.com",
                phone: "+261 34 11 111 11",
                avatar: "👨",
                bio: "Passionné de transport et de technologie",
                followers: 245,
                following: 156,
                posts: 12,
                isFollowing: false,
                isDriver: false,
                isAdmin: false,
                isRealUser: true,
                joinDate: "2023-01-15",
                status: 'active',
                lastLogin: "2024-12-20 10:30"
            },
            {
                id: 2,
                name: "Marie Ravao",
                username: "marie_vtc",
                email: "marie@example.com",
                phone: "+261 34 33 333 33",
                avatar: "👩",
                bio: "Chauffeur VTC depuis 3 ans",
                followers: 189,
                following: 89,
                posts: 8,
                isFollowing: true,
                isDriver: true,
                isAdmin: false,
                isRealUser: true,
                joinDate: "2022-08-20",
                status: 'active',
                lastLogin: "2024-12-20 09:15"
            },
            {
                id: 3,
                name: "Paul Randria",
                username: "paul_driver",
                email: "paul@example.com",
                phone: "+261 34 22 222 22",
                avatar: "👨",
                bio: "Service premium 24/7",
                followers: 312,
                following: 210,
                posts: 15,
                isFollowing: false,
                isDriver: true,
                isAdmin: false,
                isRealUser: true,
                joinDate: "2023-03-10",
                status: 'active',
                lastLogin: "2024-12-19 14:20"
            },
            {
                id: 4,
                name: "Admin VTC",
                username: "admin_vtc",
                email: "admin@vtc401.com",
                phone: "+261 34 00 000 00",
                avatar: "👑",
                bio: "Administrateur VTC Mahajanga",
                followers: 1000,
                following: 50,
                posts: 45,
                isFollowing: false,
                isDriver: false,
                isAdmin: true,
                isRealUser: true,
                joinDate: "2022-01-01",
                status: 'active',
                lastLogin: "2024-12-20 11:45"
            }
        ];

        const SAMPLE_POSTS = [
            {
                id: 1,
                userId: 1,
                userName: "Rakoto Jean",
                userAvatar: "👨",
                content: "Super expérience avec VTC Mahajanga aujourd'hui ! Service rapide et professionnel. 🚗✨ #VTC #Mahajanga",
                media: [{
                    type: 'video',
                    url: 'https://assets.mixkit.co/videos/preview/mixkit-driving-on-a-two-lane-road-in-a-forest-44337-large.mp4',
                    aspectRatio: '16:9'
                }],
                likes: 45,
                comments: 8,
                shares: 3,
                isLiked: false,
                timestamp: "2 heures",
                location: "Mahajanga Centre",
                tags: ["VTC", "Mahajanga"],
                status: 'active'
            },
            {
                id: 2,
                userId: 2,
                userName: "Marie Ravao",
                userAvatar: "👩",
                content: "Nouveau TukTuk 3 roues ajouté à ma flotte ! Parfait pour les petites rues de Mahajanga. 🛺💫 #Chauffeur #TukTuk",
                media: [{
                    type: 'image',
                    url: 'https://images.unsplash.com/photo-1566279606472-8913d5d639b0?w=800&auto=format&fit=crop',
                    aspectRatio: '16:9'
                }],
                likes: 89,
                comments: 15,
                shares: 7,
                isLiked: true,
                timestamp: "5 heures",
                location: "Mahajanga Garage",
                tags: ["Chauffeur", "TukTuk"],
                status: 'active'
            },
            {
                id: 3,
                userId: 3,
                userName: "Paul Randria",
                userAvatar: "👨",
                content: "Promotion spéciale ce week-end : -20% sur tous les trajets vers l'aéroport ! ✈️📱 Réservez sur l'app VTC Mahajanga. #Promotion #Aéroport",
                media: [{
                    type: 'video',
                    url: 'https://assets.mixkit.co/videos/preview/mixkit-aerial-view-of-a-city-with-many-high-rise-buildings-3973-large.mp4',
                    aspectRatio: '9:16'
                }],
                likes: 112,
                comments: 23,
                shares: 12,
                isLiked: false,
                timestamp: "1 jour",
                location: "Aéroport Mahajanga",
                tags: ["Promotion", "Aéroport"],
                status: 'active'
            },
            {
                id: 4,
                userId: 4,
                userName: "Admin VTC",
                userAvatar: "👑",
                content: "🎉 NOUVEAUTÉ ! La boutique VTC Mahajanga est maintenant ouverte ! Commandez nourriture, accessoires et produits partenaires. Livraison rapide partout à Mahajanga. 🛍️🚗",
                media: [{
                    type: 'image',
                    url: 'https://images.unsplash.com/photo-1556742049-0cfed4f6a45d?w=800&auto=format&fit=crop',
                    aspectRatio: '16:9'
                }],
                likes: 156,
                comments: 32,
                shares: 18,
                isLiked: false,
                timestamp: "Aujourd'hui",
                location: "VTC Mahajanga",
                tags: ["Nouveauté", "Boutique", "Livraison"],
                status: 'active'
            }
        ];

        const SAMPLE_NEWS = [
            {
                id: 1,
                title: "Nouveau partenariat avec AssurMad",
                excerpt: "Bénéficiez de 15% de réduction sur l'assurance véhicule pour tous nos chauffeurs.",
                content: "Nous sommes fiers d'annoncer notre nouveau partenariat avec AssurMad, leader de l'assurance à Madagascar. Tous nos chauffeurs bénéficient désormais de 15% de réduction sur les assurances véhicule.<br><br>Avantages inclus :<br>• Couverture complète tous risques<br>• Assistance 24h/24 et 7j/7<br>• Dépannage rapide sur toute l'île<br>• Garantie à l'étranger",
                category: "Partenariat",
                date: "Aujourd'hui",
                image: "🛡️",
                partner: "AssurMad"
            },
            {
                id: 2,
                title: "Formation chauffeurs gratuite",
                excerpt: "Session de formation certifiante le 25 décembre au Centre Mahajanga.",
                content: "Nous organisons une session de formation gratuite pour tous les chauffeurs souhaitant améliorer leurs compétences. La formation aura lieu le 25 décembre au Centre de Formation Mahajanga.<br><br>Programme :<br>• Techniques de conduite avancée<br>• Service client premium<br>• Gestion d'entreprise VTC<br>• Certification officielle",
                category: "Événement",
                date: "Hier",
                image: "🎓",
                partner: "Académie VTC"
            },
            {
                id: 3,
                title: "Promotion Noël 2024",
                excerpt: "-30% sur toutes les courses du 20 au 31 décembre pour célébrer Noël.",
                content: "Pour célébrer Noël, nous offrons -30% sur toutes les courses du 20 au 31 décembre 2024 ! Profitez de cette promotion exceptionnelle pour vos déplacements de fin d'année.<br><br>Conditions :<br>• Valable du 20/12/2024 au 31/12/2024<br>• Pour tous les types de véhicules<br>• Cumulable avec le Pack Partenaire Gold<br>• Réservation via l'application uniquement",
                category: "Promotion",
                date: "2 jours",
                image: "🎄",
                partner: "VTC Mahajanga"
            },
            {
                id: 4,
                title: "Nouvelle application mobile",
                excerpt: "Téléchargez notre nouvelle application avec des fonctionnalités améliorées.",
                content: "Notre nouvelle application mobile est disponible ! Téléchargez-la dès maintenant pour bénéficier de nombreuses améliorations :<br><br>Nouvelles fonctionnalités :<br>• Boutique intégrée<br>• Réseau social VTC<br>• Suivi en temps réel amélioré<br>• Paiements plus rapides<br>• Interface plus intuitive",
                category: "Nouveauté",
                date: "3 jours",
                image: "📱",
                partner: "VTC Mahajanga"
            }
        ];

        // ===== INITIALISATION =====
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupPWA();
            setupVideoHandlers();
            setupMapControls();
        });

        function initializeApp() {
            loadSampleData();
            initializeUI();
            initializeMap();
            checkAuth();
            initializeShop();
            loadNotifications();
            loadNews();
            renderProducts();
            renderPosts();
            renderRecentPosts();
            renderDriversList();
            renderConversations();
            renderSuggestedUsers();
            
            startRealTimeUpdates();
            checkGeolocation();
            simulateMessages();
            
            setTimeout(initVideoPlayers, 500);
            updateMessagesCount();
        }

        function loadSampleData() {
            AppState.drivers = SAMPLE_DRIVERS;
            AppState.posts = SAMPLE_POSTS;
            AppState.users = SAMPLE_USERS;
            AppState.products = SAMPLE_PRODUCTS;
            AppState.news = SAMPLE_NEWS;
            AppState.adminData.users = SAMPLE_USERS;
            AppState.adminData.drivers = SAMPLE_DRIVERS;
            AppState.adminData.posts = SAMPLE_POSTS;
            
            loadFromLocalStorage();
            updateNotifications();
            updateAdminStats();
        }

        function loadFromLocalStorage() {
            const savedCart = localStorage.getItem('vtc_cart');
            if (savedCart) {
                try {
                    AppState.cart = JSON.parse(savedCart);
                } catch (e) {
                    console.error('Erreur chargement panier:', e);
                    AppState.cart = [];
                }
            }
            
            const savedWallet = localStorage.getItem('vtc_wallet');
            AppState.wallet = savedWallet ? parseInt(savedWallet) : 10000;
            
            const savedOrders = localStorage.getItem('vtc_orders');
            if (savedOrders) {
                try {
                    AppState.orders = JSON.parse(savedOrders);
                    AppState.adminData.orders = AppState.orders;
                } catch (e) {
                    console.error('Erreur chargement commandes:', e);
                    AppState.orders = [];
                    AppState.adminData.orders = [];
                }
            }
            
            const savedNotifications = localStorage.getItem('vtc_notifications');
            if (savedNotifications) {
                try {
                    AppState.notifications = JSON.parse(savedNotifications);
                } catch (e) {
                    console.error('Erreur chargement notifications:', e);
                    AppState.notifications = [];
                }
            }
            
            const savedUser = localStorage.getItem('vtc_user');
            if (savedUser) {
                try {
                    AppState.currentUser = JSON.parse(savedUser);
                    AppState.isAdmin = AppState.currentUser && AppState.currentUser.isAdmin === true;
                } catch (e) {
                    console.error('Erreur chargement utilisateur:', e);
                }
            }
            
            const savedConversations = localStorage.getItem('vtc_conversations');
            if (savedConversations) {
                try {
                    AppState.conversations = JSON.parse(savedConversations);
                } catch (e) {
                    console.error('Erreur chargement conversations:', e);
                    AppState.conversations = [];
                }
            }
        }

        function saveToLocalStorage() {
            localStorage.setItem('vtc_cart', JSON.stringify(AppState.cart));
            localStorage.setItem('vtc_wallet', AppState.wallet.toString());
            localStorage.setItem('vtc_orders', JSON.stringify(AppState.orders));
            localStorage.setItem('vtc_notifications', JSON.stringify(AppState.notifications));
            if (AppState.currentUser) {
                localStorage.setItem('vtc_user', JSON.stringify(AppState.currentUser));
            }
            localStorage.setItem('vtc_conversations', JSON.stringify(AppState.conversations));
        }

        // ===== PWA FUNCTIONALITY =====
        function setupPWA() {
            if (window.matchMedia('(display-mode: standalone)').matches) {
                AppState.isInstalled = true;
            }
            
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                AppState.deferredPrompt = e;
                
                setTimeout(() => {
                    if (!AppState.isInstalled && AppState.deferredPrompt) {
                        showPWAInstallPrompt();
                    }
                }, 5000);
            });
            
            window.addEventListener('appinstalled', () => {
                AppState.isInstalled = true;
                hidePWAInstallPrompt();
                showNotification('Application installée avec succès !', 'success');
            });
        }

        function showPWAInstallPrompt() {
            const prompt = document.getElementById('pwa-install-prompt');
            prompt.classList.remove('hidden');
        }

        function hidePWAInstallPrompt() {
            const prompt = document.getElementById('pwa-install-prompt');
            prompt.classList.add('hidden');
        }

        async function installPWA() {
            if (AppState.deferredPrompt) {
                AppState.deferredPrompt.prompt();
                const { outcome } = await AppState.deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    console.log('PWA installation accepted');
                }
                AppState.deferredPrompt = null;
                hidePWAInstallPrompt();
            }
        }

        // ===== UI INITIALIZATION =====
        function initializeUI() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const page = this.dataset.page;
                    showPage(page);
                });
            });

            document.getElementById('auth-btn').addEventListener('click', handleAuth);
            document.getElementById('toggle-auth-mode').addEventListener('click', toggleAuthMode);
            
            document.getElementById('auth-role').addEventListener('change', function() {
                const licenseField = document.getElementById('driver-license-field');
                if (this.value === 'driver') {
                    licenseField.style.display = 'block';
                } else {
                    licenseField.style.display = 'none';
                }
            });

            document.getElementById('locate-me-btn').addEventListener('click', locateUser);
            document.getElementById('center-mj-btn').addEventListener('click', centerMapOnMahajanga);
            document.getElementById('refresh-map-btn').addEventListener('click', refreshMap);
            document.getElementById('toggle-radius-btn').addEventListener('click', toggleRadius);

            document.getElementById('pickup-input').addEventListener('input', updateRideEstimate);
            document.getElementById('destination-input').addEventListener('input', updateRideEstimate);
            
            updateCartUI();
            updateWalletUI();
            
            const publishBtn = document.getElementById('publish-post-btn');
            if (publishBtn) {
                publishBtn.addEventListener('click', function(e) {
                    if (AppState.isPosting) {
                        e.preventDefault();
                        e.stopPropagation();
                        showNotification('Veuillez patienter...', 'warning');
                        return false;
                    }
                });
            }
        }

        function setupMapControls() {
            const toggleBtn = document.getElementById('toggle-radius-btn');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', toggleRadius);
            }
        }

        function setupVideoHandlers() {
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        if (mutation.target.classList.contains('active')) {
                            setTimeout(initVideoPlayers, 100);
                        } else {
                            pauseAllVideos();
                        }
                    }
                });
            });

            document.querySelectorAll('.page').forEach(page => {
                observer.observe(page, { attributes: true });
            });
        }

        // ===== VIDEO FUNCTIONS =====
        function initVideoPlayers() {
            document.querySelectorAll('.post-media video').forEach(video => {
                const videoId = `video-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                video.id = videoId;
                
                video.controls = true;
                video.playsInline = true;
                video.muted = true;
                video.preload = "metadata";
                
                video.addEventListener('loadedmetadata', function() {
                    const isVertical = this.videoHeight > this.videoWidth;
                    const container = this.closest('.post-media');
                    
                    if (isVertical) {
                        container.classList.add('vertical-video-container');
                        this.classList.add('vertical-video');
                        this.style.height = '500px';
                        this.style.maxHeight = '500px';
                        container.style.maxHeight = '500px';
                    } else {
                        container.classList.remove('vertical-video-container');
                        this.classList.remove('vertical-video');
                        this.style.height = 'auto';
                        this.style.maxHeight = '400px';
                        container.style.maxHeight = '400px';
                    }
                });
                
                const videoObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            if (video.paused) {
                                video.play().catch(e => {
                                    console.log('Autoplay prevented:', e);
                                });
                            }
                        } else {
                            if (!video.paused) {
                                video.pause();
                            }
                        }
                    });
                }, {
                    threshold: 0.3,
                    rootMargin: '50px'
                });
                
                videoObserver.observe(video);
                AppState.videoPlayers.set(videoId, videoObserver);
                
                video.addEventListener('error', function() {
                    console.error('Erreur de chargement vidéo:', this.src);
                    this.poster = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300" viewBox="0 0 400 300"><rect width="400" height="300" fill="%23000"/><text x="200" y="150" text-anchor="middle" fill="white" font-family="Arial" font-size="16">Vidéo non disponible</text></svg>';
                });
                
                video.addEventListener('play', function() {
                    if (this.muted) {
                        this.muted = false;
                        this.volume = 0.5;
                    }
                });
                
                // Ajouter le bouton plein écran
                addFullscreenButton(video);
            });
        }

        function addFullscreenButton(video) {
            const container = video.parentElement;
            if (!container) return;
            
            const fullscreenBtn = document.createElement('button');
            fullscreenBtn.className = 'video-control-btn';
            fullscreenBtn.style.cssText = `
                position: absolute;
                top: 10px;
                right: 10px;
                background: rgba(0, 0, 0, 0.7);
                border: 2px solid rgba(255, 255, 255, 0.3);
                color: white;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                cursor: pointer;
                z-index: 5;
                backdrop-filter: blur(10px);
            `;
            fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            fullscreenBtn.title = 'Plein écran';
            
            fullscreenBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                openFullscreenVideo(video);
            });
            
            container.appendChild(fullscreenBtn);
        }

        function openFullscreenVideo(video) {
            const fullscreenVideo = document.getElementById('fullscreen-video');
            const fullscreenPlayer = document.getElementById('fullscreen-video-player');
            
            // Trouver le post parent
            const postElement = video.closest('.post-card');
            if (!postElement) return;
            
            const postId = Array.from(postElement.parentElement.children).indexOf(postElement);
            const currentPost = AppState.posts[postId];
            
            if (!currentPost || !currentPost.media || currentPost.media.length === 0) return;
            
            AppState.fullscreenVideoIndex = 0;
            AppState.currentVideoPostId = postId;
            
            fullscreenPlayer.src = currentPost.media[0].url;
            fullscreenPlayer.load();
            
            fullscreenVideo.classList.add('active');
            
            // Mettre à jour les boutons de navigation
            updateVideoNavigationButtons();
            
            // Jouer automatiquement
            setTimeout(() => {
                fullscreenPlayer.play().catch(e => {
                    console.log('Autoplay prevented:', e);
                });
            }, 300);
            
            // Écouter les événements de lecture
            fullscreenPlayer.addEventListener('play', () => {
                AppState.fullscreenVideoIsPlaying = true;
                updateFullscreenControls();
            });
            
            fullscreenPlayer.addEventListener('pause', () => {
                AppState.fullscreenVideoIsPlaying = false;
                updateFullscreenControls();
            });
            
            fullscreenPlayer.addEventListener('volumechange', () => {
                AppState.fullscreenVideoIsMuted = fullscreenPlayer.muted;
                updateFullscreenControls();
            });
        }

        function closeFullscreenVideo() {
            const fullscreenVideo = document.getElementById('fullscreen-video');
            const fullscreenPlayer = document.getElementById('fullscreen-video-player');
            
            fullscreenPlayer.pause();
            fullscreenVideo.classList.remove('active');
            fullscreenPlayer.src = '';
            
            AppState.fullscreenVideoIndex = -1;
            AppState.currentVideoPostId = null;
        }

        function showPreviousVideo() {
            if (AppState.currentVideoPostId === null) return;
            
            const currentPost = AppState.posts[AppState.currentVideoPostId];
            if (!currentPost || !currentPost.media) return;
            
            AppState.fullscreenVideoIndex--;
            if (AppState.fullscreenVideoIndex < 0) {
                AppState.fullscreenVideoIndex = currentPost.media.length - 1;
            }
            
            const fullscreenPlayer = document.getElementById('fullscreen-video-player');
            fullscreenPlayer.src = currentPost.media[AppState.fullscreenVideoIndex].url;
            fullscreenPlayer.load();
            fullscreenPlayer.play();
            
            updateVideoNavigationButtons();
        }

        function showNextVideo() {
            if (AppState.currentVideoPostId === null) return;
            
            const currentPost = AppState.posts[AppState.currentVideoPostId];
            if (!currentPost || !currentPost.media) return;
            
            AppState.fullscreenVideoIndex++;
            if (AppState.fullscreenVideoIndex >= currentPost.media.length) {
                AppState.fullscreenVideoIndex = 0;
            }
            
            const fullscreenPlayer = document.getElementById('fullscreen-video-player');
            fullscreenPlayer.src = currentPost.media[AppState.fullscreenVideoIndex].url;
            fullscreenPlayer.load();
            fullscreenPlayer.play();
            
            updateVideoNavigationButtons();
        }

        function updateVideoNavigationButtons() {
            if (AppState.currentVideoPostId === null) return;
            
            const currentPost = AppState.posts[AppState.currentVideoPostId];
            if (!currentPost || !currentPost.media) return;
            
            const prevBtn = document.getElementById('prev-video-btn');
            const nextBtn = document.getElementById('next-video-btn');
            
            if (currentPost.media.length <= 1) {
                prevBtn.classList.add('disabled');
                nextBtn.classList.add('disabled');
            } else {
                prevBtn.classList.remove('disabled');
                nextBtn.classList.remove('disabled');
            }
        }

        function toggleFullscreenVideoPlay() {
            const fullscreenPlayer = document.getElementById('fullscreen-video-player');
            if (fullscreenPlayer.paused) {
                fullscreenPlayer.play();
            } else {
                fullscreenPlayer.pause();
            }
        }

        function toggleFullscreenVideoMute() {
            const fullscreenPlayer = document.getElementById('fullscreen-video-player');
            fullscreenPlayer.muted = !fullscreenPlayer.muted;
        }

        function updateFullscreenControls() {
            const playIcon = document.getElementById('fullscreen-play-icon');
            const volumeIcon = document.getElementById('fullscreen-volume-icon');
            
            if (playIcon) {
                playIcon.className = AppState.fullscreenVideoIsPlaying ? 'fas fa-pause' : 'fas fa-play';
            }
            
            if (volumeIcon) {
                volumeIcon.className = AppState.fullscreenVideoIsMuted ? 'fas fa-volume-mute' : 'fas fa-volume-up';
            }
        }

        function pauseAllVideos() {
            document.querySelectorAll('video').forEach(video => {
                if (!video.paused) {
                    video.pause();
                }
            });
        }

        function cleanupVideoPlayers() {
            AppState.videoPlayers.forEach(observer => {
                observer.disconnect();
            });
            AppState.videoPlayers.clear();
        }

        // ===== NEWS FUNCTIONS =====
        function loadNews() {
            const slider = document.getElementById('news-slider');
            if (!slider) return;
            
            slider.innerHTML = '';
            
            AppState.news.forEach(item => {
                const newsElement = document.createElement('div');
                newsElement.className = 'news-item';
                newsElement.onclick = () => showNewsDetail(item.id);
                
                let categoryClass = 'news-category';
                if (item.category === 'Événement') categoryClass += ' event';
                if (item.category === 'Promotion') categoryClass += ' promotion';
                
                newsElement.innerHTML = `
                    <div class="${categoryClass}">${item.category}</div>
                    <div class="news-title">${item.title}</div>
                    <div class="news-excerpt">${item.excerpt}</div>
                    <div class="news-meta">
                        <span>${item.date}</span>
                        <span>${item.image}</span>
                    </div>
                `;
                
                slider.appendChild(newsElement);
            });
        }

        function showNewsDetail(newsId) {
            const news = AppState.news.find(n => n.id === newsId);
            if (!news) return;
            
            document.getElementById('news-modal-title').textContent = news.title;
            
            const content = document.getElementById('news-detail-content');
            content.innerHTML = `
                <div class="text-center mb-4">
                    <div style="font-size: 48px; margin-bottom: var(--space-md);">${news.image}</div>
                    <div class="text-muted">${news.date} • ${news.partner}</div>
                </div>
                
                <div class="mb-4">
                    <h3>${news.title}</h3>
                    <div class="text-muted mb-3">${news.excerpt}</div>
                    <div class="post-text">${news.content}</div>
                </div>
                
                ${news.partner ? `
                    <div class="card mt-4">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-handshake"></i>
                                <span>Partenaire : ${news.partner}</span>
                            </div>
                        </div>
                        <div class="p-3">
                            <p>Ce partenariat vous offre des avantages exclusifs. Consultez la section "Produits Partenaires" dans la boutique pour en savoir plus.</p>
                            <button class="btn btn-partner btn-block mt-3" onclick="showPage('shop'); closeNewsDetailModal();">
                                <i class="fas fa-store"></i>
                                Voir les produits partenaires
                            </button>
                        </div>
                    </div>
                ` : ''}
            `;
            
            document.getElementById('news-detail-modal').classList.remove('hidden');
        }

        function closeNewsDetailModal() {
            document.getElementById('news-detail-modal').classList.add('hidden');
        }

        function showAllNews() {
            showNotification('Toutes les actualités seront affichées ici', 'info');
        }

        // ===== SHOP FUNCTIONS =====
        function renderProducts() {
            const foodContainer = document.getElementById('food-products');
            const accessoriesContainer = document.getElementById('accessories-products');
            const partnerContainer = document.getElementById('partner-products');
            
            if (!foodContainer || !accessoriesContainer || !partnerContainer) return;
            
            const foodProducts = AppState.products.filter(p => p.category === 'food');
            foodContainer.innerHTML = foodProducts.map(product => createProductHTML(product)).join('');
            
            const accessoryProducts = AppState.products.filter(p => p.category === 'accessories');
            accessoriesContainer.innerHTML = accessoryProducts.map(product => createProductHTML(product)).join('');
            
            const partnerProducts = AppState.products.filter(p => p.category === 'partners');
            partnerContainer.innerHTML = partnerProducts.map(product => createProductHTML(product)).join('');
        }

        function createProductHTML(product) {
            const isPartner = product.category === 'partners';
            const badgeClass = isPartner ? 'product-badge partner' : (product.featured ? 'product-badge' : '');
            const badgeText = isPartner ? 'PARTENAIRE' : (product.featured ? 'POPULAIRE' : '');
            const imageClass = isPartner ? 'product-image partner' : 'product-image';
            const priceClass = isPartner ? 'product-price partner' : 'product-price';
            const buttonClass = isPartner ? 'add-to-cart partner' : 'add-to-cart';
            
            return `
                <div class="product-card ${product.featured ? 'featured' : ''} ${isPartner ? 'partner-product' : ''}" 
                     onclick="${isPartner ? `showPartnerProductDetail(${product.id})` : `showProductDetail(${product.id})`}">
                    ${badgeText ? `<div class="${badgeClass}">${badgeText}</div>` : ''}
                    <div class="${imageClass}">
                        ${product.image}
                        ${isPartner && product.partner ? `
                            <div class="partner-badge">
                                <i class="fas fa-handshake"></i> ${product.partner}
                            </div>
                        ` : ''}
                    </div>
                    <div class="product-title">${product.name}</div>
                    <div class="product-description">${product.description}</div>
                    
                    ${isPartner && product.benefits ? `
                        <div class="product-benefits">
                            ${product.benefits.slice(0, 2).map(benefit => `
                                <div class="benefit-item">
                                    <i class="fas fa-check-circle"></i> ${benefit}
                                </div>
                            `).join('')}
                            ${product.benefits.length > 2 ? `
                                <div class="benefit-item">
                                    <i class="fas fa-plus-circle"></i> +${product.benefits.length - 2} avantages
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    <div class="product-footer">
                        <div>
                            <div class="${priceClass}">${formatPrice(product.price)}</div>
                            <div class="product-rating">
                                ${'★'.repeat(Math.floor(product.rating))}${'☆'.repeat(5 - Math.floor(product.rating))}
                                <span style="color: var(--text-secondary); margin-left: 4px;">(${product.rating})</span>
                            </div>
                        </div>
                        <button class="${buttonClass}" onclick="event.stopPropagation(); addToCart(${product.id})">
                            <i class="fas fa-cart-plus"></i>
                            Ajouter
                        </button>
                    </div>
                </div>
            `;
        }

        function showProductDetail(productId) {
            const product = AppState.products.find(p => p.id === productId);
            if (!product) return;
            
            const modalHTML = `
                <div class="modal-overlay" id="product-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="card-title">
                                <i class="fas fa-info-circle"></i>
                                <span>${product.name}</span>
                            </div>
                            <button class="modal-close" onclick="closeProductModal()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="text-center mb-4">
                            <div class="product-image" style="width: 100px; height: 100px; margin: 0 auto;">
                                ${product.image}
                            </div>
                        </div>
                        <div class="mb-3">
                            <h3>${product.name}</h3>
                            <p class="text-muted">${product.description}</p>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Prix:</span>
                                <span class="product-price">${formatPrice(product.price)}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Note:</span>
                                <span class="product-rating">
                                    ${'★'.repeat(Math.floor(product.rating))}${'☆'.repeat(5 - Math.floor(product.rating))}
                                    (${product.rating})
                                </span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Temps de préparation:</span>
                                <span>${product.preparationTime} min</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Stock:</span>
                                <span>${product.stock} unités</span>
                            </div>
                        </div>
                        <button class="btn btn-shop btn-block" onclick="addToCart(${product.id}); closeProductModal();">
                            <i class="fas fa-cart-plus"></i>
                            Ajouter au panier
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function showPartnerProductDetail(productId) {
            const product = AppState.products.find(p => p.id === productId);
            if (!product) return;
            
            document.getElementById('partner-product-title').textContent = product.name;
            
            const content = document.getElementById('partner-product-content');
            content.innerHTML = `
                <div class="text-center mb-4">
                    <div class="product-image partner" style="width: 120px; height: 120px; margin: 0 auto; font-size: 48px;">
                        ${product.image}
                        <div class="partner-badge">
                            <i class="fas fa-handshake"></i> ${product.partner}
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h3>${product.name}</h3>
                    <p class="text-muted">${product.description}</p>
                </div>
                
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-muted">Prix:</span>
                        <span class="product-price partner" style="font-size: 24px;">${formatPrice(product.price)}</span>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-muted">Note:</span>
                        <span class="product-rating">
                            ${'★'.repeat(Math.floor(product.rating))}${'☆'.repeat(5 - Math.floor(product.rating))}
                            (${product.rating})
                        </span>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-muted">Stock:</span>
                        <span>${product.stock} unités disponibles</span>
                    </div>
                </div>
                
                ${product.benefits ? `
                    <div class="card mb-4">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-gift"></i>
                                <span>Avantages inclus</span>
                            </div>
                        </div>
                        <div class="p-3">
                            ${product.benefits.map(benefit => `
                                <div class="benefit-item mb-2">
                                    <i class="fas fa-check-circle"></i>
                                    <span>${benefit}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <div class="d-flex gap-2">
                    <button class="btn btn-partner flex-1" onclick="addToCart(${product.id}); closePartnerProductModal();">
                        <i class="fas fa-cart-plus"></i>
                        Ajouter au panier
                    </button>
                    <button class="btn btn-primary flex-1" onclick="closePartnerProductModal(); showPage('home');">
                        <i class="fas fa-home"></i>
                        Accueil
                    </button>
                </div>
            `;
            
            document.getElementById('partner-product-modal').classList.remove('hidden');
        }

        function closePartnerProductModal() {
            document.getElementById('partner-product-modal').classList.add('hidden');
        }

        function closeProductModal() {
            const modal = document.getElementById('product-modal');
            if (modal) {
                modal.remove();
            }
        }

        function addToCart(productId) {
            const product = AppState.products.find(p => p.id === productId);
            if (!product) return;
            
            if (product.stock <= 0) {
                showNotification('Produit en rupture de stock', 'error');
                return;
            }
            
            const existingItem = AppState.cart.find(item => item.id === productId);
            
            if (existingItem) {
                if (existingItem.quantity >= product.stock) {
                    showNotification('Stock insuffisant', 'error');
                    return;
                }
                existingItem.quantity += 1;
            } else {
                AppState.cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: 1,
                    image: product.image,
                    category: product.category,
                    partner: product.partner
                });
            }
            
            product.stock -= 1;
            
            saveToLocalStorage();
            updateCartUI();
            showNotification(`${product.name} ajouté au panier`, 'success');
        }

        function removeFromCart(productId) {
            const product = AppState.products.find(p => p.id === productId);
            const itemIndex = AppState.cart.findIndex(item => item.id === productId);
            
            if (itemIndex > -1) {
                const item = AppState.cart[itemIndex];
                
                if (product) {
                    product.stock += item.quantity;
                }
                
                AppState.cart.splice(itemIndex, 1);
                saveToLocalStorage();
                updateCartUI();
                showNotification('Article retiré du panier', 'info');
            }
        }

        function updateCartUI() {
            const cartCount = document.getElementById('cart-count');
            const shopBadge = document.getElementById('shop-badge');
            const totalItems = AppState.cart.reduce((sum, item) => sum + item.quantity, 0);
            
            cartCount.textContent = totalItems;
            shopBadge.textContent = totalItems;
            
            if (totalItems > 0) {
                cartCount.classList.remove('hidden');
                shopBadge.classList.remove('hidden');
            } else {
                cartCount.classList.add('hidden');
                shopBadge.classList.add('hidden');
            }
            
            updateCartItems();
            updateOrderSummary();
            updateModalCart();
            calculateDeliveryPrice();
        }

        function updateCartItems() {
            const cartItems = document.getElementById('cart-items');
            const emptyCartMsg = document.getElementById('empty-cart-message');
            const orderSummary = document.getElementById('order-summary');
            
            if (!cartItems) return;
            
            if (AppState.cart.length === 0) {
                cartItems.innerHTML = '';
                cartItems.appendChild(emptyCartMsg);
                emptyCartMsg.classList.remove('hidden');
                orderSummary.classList.add('hidden');
                return;
            }
            
            emptyCartMsg.classList.add('hidden');
            orderSummary.classList.remove('hidden');
            
            cartItems.innerHTML = '';
            AppState.cart.forEach(item => {
                const isPartner = item.category === 'partners';
                const itemElement = document.createElement('div');
                itemElement.className = 'order-item';
                itemElement.innerHTML = `
                    <div class="order-info">
                        <div class="order-title">${item.name}</div>
                        <div class="order-details">${formatPrice(item.price)} × ${item.quantity}</div>
                        ${isPartner && item.partner ? `
                            <div class="text-muted" style="font-size: 10px; margin-top: 2px;">
                                <i class="fas fa-handshake"></i> ${item.partner}
                            </div>
                        ` : ''}
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <div style="font-weight: 700; color: ${isPartner ? 'var(--partner-color)' : 'inherit'}">
                            ${formatPrice(item.price * item.quantity)}
                        </div>
                        <button onclick="removeFromCart(${item.id})" style="
                            background: var(--danger);
                            color: white;
                            border: none;
                            width: 28px;
                            height: 28px;
                            border-radius: 50%;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 12px;
                        ">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                cartItems.appendChild(itemElement);
            });
        }

        function calculateDeliveryPrice() {
            const subtotal = AppState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const hasPartnerProduct = AppState.cart.some(item => item.category === 'partners');
            
            if (hasPartnerProduct) {
                AppState.deliveryPrice = 0;
            } else {
                const distance = Math.random() * 5 + 1;
                const deliveryCost = CONFIG.DELIVERY_RATES.base_fee + 
                                   (distance * CONFIG.DELIVERY_RATES.per_km) + 
                                   CONFIG.DELIVERY_RATES.service_fee;
                
                AppState.deliveryPrice = Math.round(deliveryCost);
                AppState.deliveryDistance = distance.toFixed(1);
            }
            
            updateOrderSummary();
        }

        function updateOrderSummary() {
            const subtotal = AppState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const delivery = AppState.deliveryPrice;
            const total = subtotal + delivery;
            
            document.getElementById('subtotal').textContent = formatPrice(subtotal);
            document.getElementById('delivery-cost').textContent = formatPrice(delivery);
            document.getElementById('total-cost').textContent = formatPrice(total);
        }

        function updateModalCart() {
            const container = document.getElementById('modal-cart-items');
            const subtotalEl = document.getElementById('modal-subtotal');
            const deliveryEl = document.getElementById('modal-delivery');
            const totalEl = document.getElementById('modal-total');
            
            if (!container) return;
            
            if (AppState.cart.length === 0) {
                container.innerHTML = '<div class="text-center text-muted p-4">Panier vide</div>';
                subtotalEl.textContent = '0 Ar';
                deliveryEl.textContent = '0 Ar';
                totalEl.textContent = '0 Ar';
                return;
            }
            
            const subtotal = AppState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const total = subtotal + AppState.deliveryPrice;
            
            container.innerHTML = '';
            AppState.cart.forEach(item => {
                const isPartner = item.category === 'partners';
                const itemElement = document.createElement('div');
                itemElement.className = 'order-item';
                itemElement.innerHTML = `
                    <div class="order-info">
                        <div class="order-title">${item.name}</div>
                        <div class="order-details">${formatPrice(item.price)} × ${item.quantity}</div>
                        ${isPartner && item.partner ? `
                            <div class="text-muted" style="font-size: 10px; margin-top: 2px;">
                                <i class="fas fa-handshake"></i> ${item.partner}
                            </div>
                        ` : ''}
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <div style="font-weight: 700; color: ${isPartner ? 'var(--partner-color)' : 'inherit'}">
                            ${formatPrice(item.price * item.quantity)}
                        </div>
                        <button onclick="removeFromCart(${item.id}); updateModalCart();" style="
                            background: var(--danger);
                            color: white;
                            border: none;
                            width: 28px;
                            height: 28px;
                            border-radius: 50%;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 12px;
                        ">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                container.appendChild(itemElement);
            });
            
            subtotalEl.textContent = formatPrice(subtotal);
            deliveryEl.textContent = formatPrice(AppState.deliveryPrice);
            totalEl.textContent = formatPrice(total);
        }

        // ===== TRANSPORT FUNCTIONS =====
        function selectRideType(type) {
            AppState.selectedRideType = type;
            
            document.querySelectorAll('.ride-type').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelector(`.ride-type[data-type="${type}"]`).classList.add('selected');
            
            updateRideEstimate();
        }

        function updateRideEstimate() {
            const pickup = document.getElementById('pickup-input').value;
            const destination = document.getElementById('destination-input').value;
            
            if (!pickup || !destination) {
                return;
            }
            
            const distance = Math.random() * 10 + 1;
            const pricePerKm = CONFIG.PRICE_RATES[AppState.selectedRideType];
            const estimatedPrice = Math.round(distance * pricePerKm);
            const estimatedTime = Math.round(distance * 3 + 5);
            
            document.getElementById('estimate-price').textContent = formatPrice(estimatedPrice);
            document.getElementById('estimate-time').textContent = `${estimatedTime} min`;
        }

        function findDrivers() {
            const pickup = document.getElementById('pickup-input').value;
            const destination = document.getElementById('destination-input').value;
            
            if (!pickup || !destination) {
                showNotification('Veuillez remplir les deux adresses', 'error');
                return;
            }
            
            const availableDrivers = AppState.drivers.filter(driver => 
                driver.status === 'available' && 
                driver.type === AppState.selectedRideType
            );
            
            if (availableDrivers.length === 0) {
                showNotification('Aucun chauffeur disponible pour ce type de véhicule', 'warning');
                return;
            }
            
            const driversCard = document.getElementById('available-drivers-card');
            const driversContainer = document.getElementById('available-drivers');
            
            driversCard.style.display = 'block';
            driversContainer.innerHTML = '';
            
            const distance = Math.random() * 10 + 1;
            const pricePerKm = CONFIG.PRICE_RATES[AppState.selectedRideType];
            const basePrice = Math.round(distance * pricePerKm);
            
            availableDrivers.forEach(driver => {
                const driverPrice = Math.round(basePrice * driver.priceMultiplier);
                const driverElement = document.createElement('div');
                driverElement.className = 'driver-card';
                driverElement.onclick = () => selectDriver(driver);
                driverElement.innerHTML = `
                    <div class="driver-avatar">
                        ${driver.type === 'tuktuk' ? '🛺' : driver.type === 'scooter' ? '🛵' : driver.type === 'van' ? '🚐' : '🚗'}
                    </div>
                    <div class="driver-info">
                        <div class="driver-name">${driver.name}</div>
                        <div class="driver-vehicle">${driver.vehicle}</div>
                        <div class="driver-rating">
                            ⭐ ${driver.rating}
                            <span class="text-muted">(${driver.distance.toFixed(1)} km)</span>
                        </div>
                    </div>
                    <div class="driver-price">${formatPrice(driverPrice)}</div>
                `;
                driversContainer.appendChild(driverElement);
            });
            
            showNotification(`${availableDrivers.length} chauffeur(s) disponible(s)`, 'success');
        }

        function selectDriver(driver) {
            AppState.currentDriver = driver;
            
            document.querySelectorAll('.driver-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            const distance = Math.random() * 10 + 1;
            const pricePerKm = CONFIG.PRICE_RATES[AppState.selectedRideType];
            const price = Math.round(distance * pricePerKm * driver.priceMultiplier);
            const time = Math.round(distance * 3 + 5);
            
            const confirmHTML = `
                <div class="card mt-3">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-check-circle"></i>
                            <span>Confirmer la course</span>
                        </div>
                    </div>
                    <div class="p-3">
                        <div class="d-flex align-items-center gap-3 mb-3">
                            <div class="driver-avatar">
                                ${driver.type === 'tuktuk' ? '🛺' : driver.type === 'scooter' ? '🛵' : driver.type === 'van' ? '🚐' : '🚗'}
                            </div>
                            <div>
                                <div class="driver-name">${driver.name}</div>
                                <div class="driver-vehicle">${driver.vehicle} • ${driver.plate}</div>
                            </div>
                        </div>
                        <div class="ride-estimate">
                            <div class="estimate-price">${formatPrice(price)}</div>
                            <div class="estimate-time">${time} minutes</div>
                        </div>
                        <button class="btn btn-success btn-block mt-3" onclick="confirmRide()">
                            <i class="fas fa-check"></i>
                            Confirmer la course
                        </button>
                    </div>
                </div>
            `;
            
            const driversContainer = document.getElementById('available-drivers');
            driversContainer.insertAdjacentHTML('beforeend', confirmHTML);
        }

        function confirmRide() {
            if (!AppState.currentDriver) return;
            
            const distance = Math.random() * 10 + 1;
            const pricePerKm = CONFIG.PRICE_RATES[AppState.selectedRideType];
            const price = Math.round(distance * pricePerKm * AppState.currentDriver.priceMultiplier);
            
            if (AppState.wallet < price) {
                showNotification('Fonds insuffisants. Veuillez recharger votre portefeuille.', 'error');
                showAddMoneyModal();
                return;
            }
            
            AppState.wallet -= price;
            saveToLocalStorage();
            updateWalletUI();
            
            AppState.currentDriver.status = 'busy';
            
            const ride = {
                id: Date.now(),
                driver: AppState.currentDriver,
                type: AppState.selectedRideType,
                price: price,
                distance: distance.toFixed(1),
                status: 'active',
                startTime: new Date().toISOString(),
                estimatedArrival: new Date(Date.now() + (distance * 3 + 5) * 60000).toISOString()
            };
            
            AppState.currentRide = ride;
            
            AppState.orders.unshift({
                id: ride.id,
                type: 'ride',
                date: new Date().toLocaleDateString('fr-FR'),
                details: `Course avec ${AppState.currentDriver.name}`,
                amount: -price,
                status: 'active'
            });
            
            saveToLocalStorage();
            updateOrdersUI();
            updateAdminStats();
            
            showNotification(`Course confirmée avec ${AppState.currentDriver.name}`, 'success');
            
            startRideTracking();
        }

        function startRideTracking() {
            if (!AppState.currentRide || !AppState.currentDriver) return;
            
            document.getElementById('tracking-driver-avatar').innerHTML = 
                AppState.currentDriver.type === 'tuktuk' ? '🛺' : 
                AppState.currentDriver.type === 'scooter' ? '🛵' : 
                AppState.currentDriver.type === 'van' ? '🚐' : '🚗';
            
            document.getElementById('tracking-driver-name').textContent = AppState.currentDriver.name;
            document.getElementById('tracking-vehicle').textContent = `${AppState.currentDriver.vehicle} • ${AppState.currentDriver.plate}`;
            document.getElementById('tracking-price').textContent = formatPrice(AppState.currentRide.price);
            
            document.getElementById('ride-tracking').classList.remove('hidden');
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += 2;
                document.getElementById('ride-progress-fill').style.width = `${progress}%`;
                
                if (progress >= 100) {
                    clearInterval(interval);
                    completeRide();
                }
            }, 1000);
            
            if (AppState.map) {
                if (AppState.userMarker) {
                    const userPos = AppState.userMarker.getLatLng();
                    const route = L.polyline([
                        [userPos.lat, userPos.lng],
                        [AppState.currentDriver.lat, AppState.currentDriver.lng]
                    ], {
                        color: '#007AFF',
                        weight: 3,
                        opacity: 0.7,
                        dashArray: '10, 10'
                    }).addTo(AppState.map);
                    
                    AppState.currentRide.route = route;
                }
            }
        }

        function completeRide() {
            if (!AppState.currentRide) return;
            
            AppState.currentRide.status = 'completed';
            
            if (AppState.currentDriver) {
                AppState.currentDriver.status = 'available';
            }
            
            const orderIndex = AppState.orders.findIndex(o => o.id === AppState.currentRide.id);
            if (orderIndex !== -1) {
                AppState.orders[orderIndex].status = 'completed';
                saveToLocalStorage();
            }
            
            addNotification({
                id: Date.now(),
                type: 'ride_completed',
                title: 'Course terminée',
                message: `Votre course avec ${AppState.currentDriver ? AppState.currentDriver.name : 'le chauffeur'} est terminée.`,
                time: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
                read: false
            });
            
            document.getElementById('ride-tracking').classList.add('hidden');
            
            if (AppState.currentRide.route) {
                AppState.currentRide.route.remove();
            }
            
            showNotification('Course terminée ! Merci d\'avoir utilisé VTC Mahajanga.', 'success');
            
            AppState.currentRide = null;
            AppState.currentDriver = null;
        }

        function cancelRide() {
            if (!AppState.currentRide) return;
            
            if (confirm('Voulez-vous vraiment annuler cette course ?')) {
                AppState.wallet += AppState.currentRide.price;
                saveToLocalStorage();
                updateWalletUI();
                
                if (AppState.currentDriver) {
                    AppState.currentDriver.status = 'available';
                }
                
                const orderIndex = AppState.orders.findIndex(o => o.id === AppState.currentRide.id);
                if (orderIndex !== -1) {
                    AppState.orders[orderIndex].status = 'cancelled';
                    saveToLocalStorage();
                }
                
                document.getElementById('ride-tracking').classList.add('hidden');
                
                if (AppState.currentRide.route) {
                    AppState.currentRide.route.remove();
                }
                
                showNotification('Course annulée. Le montant a été remboursé.', 'info');
                
                AppState.currentRide = null;
                AppState.currentDriver = null;
            }
        }

        // ===== SOCIAL FUNCTIONS =====
        function renderPosts() {
            const container = document.getElementById('posts-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Filtrer les posts pour n'afficher que ceux des vrais utilisateurs
            const realUserPosts = AppState.posts.filter(post => {
                const user = AppState.users.find(u => u.id === post.userId);
                return user && user.isRealUser === true;
            });
            
            realUserPosts.forEach(post => {
                const user = AppState.users.find(u => u.id === post.userId);
                if (!user) return;
                
                const postElement = document.createElement('div');
                postElement.className = 'post-card';
                postElement.innerHTML = createPostHTML(post, user);
                container.appendChild(postElement);
            });
            
            setTimeout(initVideoPlayers, 100);
        }

        function renderRecentPosts() {
            const container = document.getElementById('recent-posts-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Filtrer les posts pour n'afficher que ceux des vrais utilisateurs
            const realUserPosts = AppState.posts.filter(post => {
                const user = AppState.users.find(u => u.id === post.userId);
                return user && user.isRealUser === true;
            }).slice(0, CONFIG.MAX_POSTS_HOME);
            
            if (realUserPosts.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted p-4">
                        <i class="fas fa-newspaper" style="font-size: 36px; margin-bottom: var(--space-sm);"></i>
                        <div>Aucune publication récente</div>
                        <button class="btn btn-primary mt-3" onclick="showPage('social')">
                            <i class="fas fa-plus"></i>
                            Créer une publication
                        </button>
                    </div>
                `;
                return;
            }
            
            realUserPosts.forEach(post => {
                const user = AppState.users.find(u => u.id === post.userId);
                if (!user) return;
                
                const postElement = document.createElement('div');
                postElement.className = 'post-card';
                postElement.innerHTML = createPostHTML(post, user, true);
                container.appendChild(postElement);
            });
        }

        function createPostHTML(post, user, isCompact = false) {
            let mediaHTML = '';
            if (post.media && post.media.length > 0) {
                const media = post.media[0];
                if (media.type === 'video') {
                    const isVertical = media.aspectRatio === '9:16';
                    mediaHTML = `
                        <div class="post-media ${isVertical ? 'vertical-video-container' : ''}">
                            <video 
                                controls 
                                playsinline 
                                ${isVertical ? 'class="vertical-video"' : ''}
                                poster="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='400' height='${isVertical ? '700' : '300'}' viewBox='0 0 400 ${isVertical ? '700' : '300'}'><rect width='400' height='${isVertical ? '700' : '300'}' fill='%23000'/><text x='200' y='${isVertical ? '350' : '150'}' text-anchor='middle' fill='white' font-family='Arial' font-size='16'>Chargement...</text></svg>">
                                <source src="${media.url}" type="video/mp4">
                                Votre navigateur ne supporte pas la vidéo.
                            </video>
                        </div>
                    `;
                } else {
                    mediaHTML = `
                        <div class="post-media">
                            <img src="${media.url}" alt="Image post" loading="lazy">
                        </div>
                    `;
                }
            }
            
            let badgeHTML = '';
            if (user.isAdmin) {
                badgeHTML = '<span class="admin-badge"><i class="fas fa-crown"></i> Admin</span>';
            } else if (user.isDriver) {
                badgeHTML = '<span class="driver-badge"><i class="fas fa-car"></i> Chauffeur</span>';
            } else if (user.isRealUser) {
                badgeHTML = '<span class="real-user-badge"><i class="fas fa-user-check"></i> Vrai utilisateur</span>';
            }
            
            const compactHTML = isCompact ? `
                <div class="post-text">
                    ${post.content.length > 100 ? post.content.substring(0, 100) + '...' : post.content}
                </div>
                ${mediaHTML ? mediaHTML : ''}
                <div class="post-stats mt-2">
                    <div>${post.likes} ❤️</div>
                    <div>${post.comments} 💬</div>
                    <div>${post.shares} 🔄</div>
                </div>
            ` : `
                <div class="post-text">
                    ${formatPostContent(post.content)}
                </div>
                
                ${post.tags && post.tags.length > 0 ? `
                    <div class="post-tags mt-2">
                        ${post.tags.map(tag => `<span class="post-tag">#${tag}</span>`).join(' ')}
                    </div>
                ` : ''}
                
                ${mediaHTML}
                
                <div class="post-stats">
                    <div>${post.likes} mentions J'aime</div>
                    <div>${post.comments} commentaires</div>
                    <div>${post.shares} partages</div>
                </div>
                
                <div class="post-actions">
                    <div class="post-action ${post.isLiked ? 'liked' : ''}" onclick="toggleLike(${post.id})">
                        <i class="fas fa-heart"></i>
                        <span>J'aime</span>
                    </div>
                    <div class="post-action" onclick="focusComment(${post.id})">
                        <i class="fas fa-comment"></i>
                        <span>Commenter</span>
                    </div>
                    <div class="post-action message" onclick="sendMessageToUser(${user.id})">
                        <i class="fas fa-comment-dots"></i>
                        <span>Message</span>
                    </div>
                    <div class="post-action" onclick="sharePost(${post.id})">
                        <i class="fas fa-share"></i>
                        <span>Partager</span>
                    </div>
                </div>
                
                <div class="post-comments" id="comments-${post.id}">
                    <div class="comment-form">
                        <div class="user-avatar" style="width: 30px; height: 30px; font-size: 12px;">
                            ${AppState.currentUser ? AppState.currentUser.avatar : '👤'}
                        </div>
                        <input type="text" 
                               class="comment-input" 
                               placeholder="Ajouter un commentaire..."
                               onkeypress="if(event.key === 'Enter') addComment(${post.id}, this)">
                        <button class="comment-send-btn" onclick="addComment(${post.id}, this.previousElementSibling)">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            `;
            
            return `
                <div class="post-header">
                    <div class="post-user-avatar" onclick="showUserProfile(${user.id})">
                        ${user.avatar}
                    </div>
                    <div class="post-user-info">
                        <div class="post-user-name" onclick="showUserProfile(${user.id})">
                            ${user.name}
                            ${badgeHTML}
                        </div>
                        <div class="post-time">
                            ${post.timestamp} • ${post.location}
                        </div>
                    </div>
                    <div class="post-actions">
                        <div class="post-action" onclick="reportPost(${post.id})">
                            <i class="fas fa-ellipsis-h"></i>
                        </div>
                    </div>
                </div>
                
                <div class="post-content">
                    ${compactHTML}
                </div>
            `;
        }

        function formatPostContent(content) {
            return content
                .replace(/#(\w+)/g, '<span style="color: var(--primary);">#$1</span>')
                .replace(/@(\w+)/g, '<span style="color: var(--accent);">@$1</span>');
        }

        function createPost() {
            const now = Date.now();
            const timeSinceLastPost = now - AppState.lastPostTime;
            
            if (AppState.isPosting) {
                showNotification('Publication en cours, veuillez patienter...', 'warning');
                return;
            }
            
            if (timeSinceLastPost < AppState.POST_COOLDOWN) {
                const remainingTime = Math.ceil((AppState.POST_COOLDOWN - timeSinceLastPost) / 1000);
                showNotification(`Veuillez patienter ${remainingTime} secondes avant de publier à nouveau`, 'warning');
                return;
            }
            
            const textInput = document.getElementById('post-text-input');
            const content = textInput.value.trim();
            
            if (!content && AppState.uploadedMedia.length === 0) {
                showNotification('Veuillez ajouter du texte ou une image/vidéo', 'error');
                return;
            }
            
            AppState.isPosting = true;
            AppState.lastPostTime = now;
            
            const publishBtn = document.getElementById('publish-post-btn');
            if (publishBtn) {
                publishBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publication...';
                publishBtn.disabled = true;
            }
            
            setTimeout(() => {
                const postMedia = AppState.uploadedMedia.map(media => ({
                    type: media.type,
                    url: media.url,
                    aspectRatio: media.type === 'video' ? '9:16' : '16:9'
                }));
                
                const newPost = {
                    id: Date.now(),
                    userId: AppState.currentUser ? AppState.currentUser.id : 1,
                    userName: AppState.currentUser ? AppState.currentUser.name : 'Utilisateur',
                    userAvatar: AppState.currentUser ? AppState.currentUser.avatar : '👤',
                    content: content,
                    media: postMedia,
                    likes: 0,
                    comments: 0,
                    shares: 0,
                    isLiked: false,
                    timestamp: "À l'instant",
                    location: "Mahajanga",
                    tags: extractTags(content),
                    status: 'active'
                };
                
                AppState.posts.unshift(newPost);
                AppState.adminData.posts.unshift(newPost);
                renderPosts();
                renderRecentPosts();
                
                textInput.value = '';
                AppState.uploadedMedia = [];
                document.getElementById('media-preview').innerHTML = '';
                
                if (publishBtn) {
                    publishBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Publier';
                    publishBtn.disabled = false;
                }
                
                AppState.isPosting = false;
                
                showNotification('Publication créée avec succès!', 'success');
                
                if (AppState.currentUser) {
                    updatePostCount();
                    updateAdminStats();
                }
            }, 1000);
        }

        function extractTags(content) {
            const hashtags = content.match(/#(\w+)/g);
            return hashtags ? hashtags.map(tag => tag.substring(1)) : [];
        }

        function handleMediaUpload(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            AppState.uploadedMedia = [];
            
            for (let i = 0; i < Math.min(files.length, 5); i++) {
                const file = files[i];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const media = {
                        type: file.type.startsWith('image') ? 'image' : 'video',
                        url: e.target.result,
                        file: file
                    };
                    
                    AppState.uploadedMedia.push(media);
                    updateMediaPreview();
                };
                
                reader.readAsDataURL(file);
            }
            
            showNotification('Média ajouté avec succès', 'success');
        }

        function updateMediaPreview() {
            const preview = document.getElementById('media-preview');
            if (!preview) return;
            
            preview.innerHTML = '';
            
            AppState.uploadedMedia.forEach((media, index) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'media-preview-item';
                
                if (media.type === 'image') {
                    previewItem.innerHTML = `
                        <img src="${media.url}" alt="Preview">
                        <button class="media-preview-remove" onclick="removeMedia(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                } else {
                    previewItem.innerHTML = `
                        <video src="${media.url}" controls></video>
                        <button class="media-preview-remove" onclick="removeMedia(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                }
                
                preview.appendChild(previewItem);
            });
        }

        function removeMedia(index) {
            AppState.uploadedMedia.splice(index, 1);
            updateMediaPreview();
        }

        function toggleLike(postId) {
            const post = AppState.posts.find(p => p.id === postId);
            if (!post) return;
            
            post.isLiked = !post.isLiked;
            post.likes += post.isLiked ? 1 : -1;
            
            renderPosts();
            renderRecentPosts();
        }

        function addComment(postId, inputElement) {
            const commentText = inputElement.value.trim();
            if (!commentText) return;
            
            const post = AppState.posts.find(p => p.id === postId);
            if (!post) return;
            
            post.comments += 1;
            inputElement.value = '';
            
            renderPosts();
            showNotification('Commentaire ajouté', 'success');
        }

        function sharePost(postId) {
            const post = AppState.posts.find(p => p.id === postId);
            if (!post) return;
            
            post.shares += 1;
            renderPosts();
            
            if (navigator.share) {
                navigator.share({
                    title: `Publication de ${post.userName}`,
                    text: post.content,
                    url: window.location.href
                }).then(() => {
                    showNotification('Publication partagée', 'success');
                }).catch(() => {
                    navigator.clipboard.writeText(post.content);
                    showNotification('Publication copiée dans le presse-papier', 'success');
                });
            } else {
                navigator.clipboard.writeText(post.content);
                showNotification('Publication copiée dans le presse-papier', 'success');
            }
        }

        // ===== MESSAGES FUNCTIONS =====
        function renderConversations() {
            const container = document.getElementById('conversations-list');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (AppState.conversations.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted p-4">
                        <i class="fas fa-comments" style="font-size: 36px; margin-bottom: var(--space-sm);"></i>
                        <div>Aucune conversation</div>
                        <button class="btn btn-primary mt-3" onclick="startNewConversation()">
                            <i class="fas fa-plus"></i>
                            Commencer une conversation
                        </button>
                    </div>
                `;
                return;
            }
            
            AppState.conversations.sort((a, b) => {
                const aTime = a.messages && a.messages.length > 0 ? 
                    new Date(a.messages[a.messages.length - 1].timestamp) : new Date(a.createdAt);
                const bTime = b.messages && b.messages.length > 0 ? 
                    new Date(b.messages[b.messages.length - 1].timestamp) : new Date(b.createdAt);
                return bTime - aTime;
            });
            
            AppState.conversations.forEach(conversation => {
                const otherUser = AppState.users.find(u => u.id === conversation.userId);
                if (!otherUser) return;
                
                const lastMessage = conversation.messages && conversation.messages.length > 0 ? 
                    conversation.messages[conversation.messages.length - 1] : null;
                
                const unreadCount = conversation.messages ? 
                    conversation.messages.filter(m => !m.read && m.senderId === conversation.userId).length : 0;
                
                const conversationElement = document.createElement('div');
                conversationElement.className = 'conversation-item';
                conversationElement.onclick = () => openConversation(conversation.id);
                
                conversationElement.innerHTML = `
                    <div class="conversation-avatar">
                        ${otherUser.avatar}
                    </div>
                    <div class="conversation-info">
                        <div class="conversation-user">${otherUser.name}</div>
                        <div class="conversation-preview">
                            ${lastMessage ? (lastMessage.senderId === conversation.userId ? '' : 'Vous: ') + lastMessage.text : 'Aucun message'}
                        </div>
                    </div>
                    <div class="conversation-meta">
                        <div class="conversation-time">
                            ${lastMessage ? formatMessageTime(lastMessage.timestamp) : formatMessageTime(conversation.createdAt)}
                        </div>
                        ${unreadCount > 0 ? `
                            <div class="conversation-unread">
                                ${unreadCount}
                            </div>
                        ` : ''}
                    </div>
                `;
                
                container.appendChild(conversationElement);
            });
            
            updateMessagesCount();
        }

        function renderSuggestedUsers() {
            const container = document.getElementById('suggested-users');
            if (!container) return;
            
            container.innerHTML = '';
            
            const existingUserIds = AppState.conversations.map(c => c.userId);
            const suggestedUsers = AppState.users.filter(user => 
                user.id !== (AppState.currentUser ? AppState.currentUser.id : 0) &&
                !existingUserIds.includes(user.id) &&
                user.isRealUser === true
            ).slice(0, 3);
            
            if (suggestedUsers.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted p-3">
                        <div>Aucune suggestion disponible</div>
                    </div>
                `;
                return;
            }
            
            suggestedUsers.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'conversation-item';
                userElement.onclick = () => startConversationWithUser(user.id);
                
                userElement.innerHTML = `
                    <div class="conversation-avatar">
                        ${user.avatar}
                    </div>
                    <div class="conversation-info">
                        <div class="conversation-user">${user.name}</div>
                        <div class="conversation-preview">
                            ${user.bio || 'Membre VTC Mahajanga'}
                        </div>
                    </div>
                    <div class="conversation-meta">
                        <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); startConversationWithUser(${user.id})">
                            <i class="fas fa-comment"></i>
                        </button>
                    </div>
                `;
                
                container.appendChild(userElement);
            });
        }

        function startNewConversation() {
            document.getElementById('new-conversation-modal').classList.remove('hidden');
        }

        function closeNewConversationModal() {
            document.getElementById('new-conversation-modal').classList.add('hidden');
            document.getElementById('search-user-input').value = '';
            document.getElementById('search-users-results').innerHTML = '';
        }

        function searchUsersForMessage(query) {
            const resultsContainer = document.getElementById('search-users-results');
            if (!resultsContainer) return;
            
            if (!query.trim()) {
                resultsContainer.innerHTML = `
                    <div class="text-center text-muted p-3">
                        <div>Recherchez un utilisateur par nom, email ou @username</div>
                    </div>
                `;
                return;
            }
            
            const filteredUsers = AppState.users.filter(user => 
                user.id !== (AppState.currentUser ? AppState.currentUser.id : 0) &&
                user.isRealUser === true &&
                (user.name.toLowerCase().includes(query.toLowerCase()) ||
                 user.email.toLowerCase().includes(query.toLowerCase()) ||
                 user.username.toLowerCase().includes(query.toLowerCase()))
            );
            
            resultsContainer.innerHTML = '';
            
            if (filteredUsers.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="text-center text-muted p-3">
                        <div>Aucun utilisateur trouvé</div>
                    </div>
                `;
                return;
            }
            
            filteredUsers.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'conversation-item';
                userElement.onclick = () => {
                    startConversationWithUser(user.id);
                    closeNewConversationModal();
                };
                
                userElement.innerHTML = `
                    <div class="conversation-avatar">
                        ${user.avatar}
                    </div>
                    <div class="conversation-info">
                        <div class="conversation-user">${user.name}</div>
                        <div class="conversation-preview">
                            @${user.username} • ${user.email}
                        </div>
                    </div>
                    <div class="conversation-meta">
                        <button class="btn btn-sm btn-primary">
                            <i class="fas fa-comment"></i>
                        </button>
                    </div>
                `;
                
                resultsContainer.appendChild(userElement);
            });
        }

        function startConversationWithUser(userId) {
            const user = AppState.users.find(u => u.id === userId);
            if (!user) return;
            
            let conversation = AppState.conversations.find(c => c.userId === userId);
            
            if (!conversation) {
                conversation = {
                    id: Date.now(),
                    userId: user.id,
                    userName: user.name,
                    userAvatar: user.avatar,
                    messages: [],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                AppState.conversations.push(conversation);
                saveToLocalStorage();
            }
            
            AppState.currentConversation = conversation;
            openMessagesModal();
        }

        function openConversation(conversationId) {
            const conversation = AppState.conversations.find(c => c.id === conversationId);
            if (!conversation) return;
            
            AppState.currentConversation = conversation;
            openMessagesModal();
        }

        function openMessagesModal() {
            if (!AppState.currentConversation) return;
            
            const otherUser = AppState.users.find(u => u.id === AppState.currentConversation.userId);
            if (!otherUser) return;
            
            document.getElementById('messages-modal-title').textContent = otherUser.name;
            renderMessages();
            
            if (AppState.currentConversation.messages) {
                AppState.currentConversation.messages.forEach(message => {
                    if (message.senderId === AppState.currentConversation.userId) {
                        message.read = true;
                    }
                });
            }
            
            saveToLocalStorage();
            updateMessagesCount();
            renderConversations();
            
            document.getElementById('messages-modal').classList.remove('hidden');
        }

        function closeMessagesModal() {
            document.getElementById('messages-modal').classList.add('hidden');
            AppState.currentConversation = null;
        }

        function renderMessages() {
            if (!AppState.currentConversation) return;
            
            const container = document.getElementById('messages-list');
            const messageInput = document.getElementById('message-input');
            
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!AppState.currentConversation.messages || AppState.currentConversation.messages.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted p-4">
                        <i class="fas fa-comment-slash" style="font-size: 36px; margin-bottom: var(--space-sm);"></i>
                        <div>Aucun message</div>
                        <div class="text-muted mt-2" style="font-size: 12px;">
                            Commencez la conversation avec ${AppState.currentConversation.userName}
                        </div>
                    </div>
                `;
                return;
            }
            
            AppState.currentConversation.messages.forEach(message => {
                const isSent = message.senderId !== AppState.currentConversation.userId;
                const messageElement = document.createElement('div');
                messageElement.className = `message ${isSent ? 'sent' : 'received'}`;
                
                if (!isSent) {
                    messageElement.innerHTML = `
                        <div class="message-sender">${AppState.currentConversation.userName}</div>
                        <div class="message-text">${message.text}</div>
                        <div class="message-time">
                            ${formatMessageTime(message.timestamp)}
                            ${message.read ? ' ✓✓' : ' ✓'}
                        </div>
                    `;
                } else {
                    messageElement.innerHTML = `
                        <div class="message-text">${message.text}</div>
                        <div class="message-time">
                            ${formatMessageTime(message.timestamp)}
                        </div>
                    `;
                }
                
                container.appendChild(messageElement);
            });
            
            container.scrollTop = container.scrollHeight;
            
            if (messageInput) {
                messageInput.focus();
            }
        }

        function sendMessage() {
            if (!AppState.currentConversation) {
                showNotification('Aucune conversation sélectionnée', 'error');
                return;
            }
            
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            if (!text) return;
            
            const newMessage = {
                id: Date.now(),
                senderId: AppState.currentUser ? AppState.currentUser.id : 0,
                text: text,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            if (!AppState.currentConversation.messages) {
                AppState.currentConversation.messages = [];
            }
            
            AppState.currentConversation.messages.push(newMessage);
            AppState.currentConversation.updatedAt = new Date().toISOString();
            
            const otherUser = AppState.users.find(u => u.id === AppState.currentConversation.userId);
            if (otherUser) {
                AppState.adminData.messages.push({
                    id: newMessage.id,
                    from: AppState.currentUser ? AppState.currentUser.name : 'Utilisateur',
                    to: otherUser.name,
                    message: text,
                    time: new Date().toLocaleTimeString('fr-FR'),
                    read: false
                });
            }
            
            saveToLocalStorage();
            input.value = '';
            
            renderMessages();
            renderConversations();
            updateMessagesCount();
            updateAdminStats();
            
            setTimeout(() => {
                if (AppState.currentConversation) {
                    const replyMessage = {
                        id: Date.now() + 1,
                        senderId: AppState.currentConversation.userId,
                        text: getRandomReply(),
                        timestamp: new Date().toISOString(),
                        read: false
                    };
                    
                    AppState.currentConversation.messages.push(replyMessage);
                    AppState.currentConversation.updatedAt = new Date().toISOString();
                    
                    saveToLocalStorage();
                    renderMessages();
                    renderConversations();
                    updateMessagesCount();
                    
                    showNotification('Nouveau message reçu', 'info');
                }
            }, 1000 + Math.random() * 2000);
        }

        function getRandomReply() {
            const replies = [
                "Salut ! Comment vas-tu ?",
                "Merci pour ton message !",
                "Je suis disponible pour discuter",
                "Intéressant ! Dis-moi en plus",
                "D'accord, je comprends",
                "On se voit bientôt peut-être ?",
                "Bon à savoir, merci !",
                "Je suis d'accord avec toi",
                "Super conversation !",
                "À bientôt sur VTC Mahajanga !"
            ];
            return replies[Math.floor(Math.random() * replies.length)];
        }

        function formatMessageTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) {
                return 'À l\'instant';
            } else if (diff < 3600000) {
                const minutes = Math.floor(diff / 60000);
                return `Il y a ${minutes} min`;
            } else if (diff < 86400000) {
                const hours = Math.floor(diff / 3600000);
                return `Il y a ${hours} h`;
            } else {
                return date.toLocaleDateString('fr-FR', { 
                    day: 'numeric', 
                    month: 'short' 
                });
            }
        }

        function updateMessagesCount() {
            let totalUnread = 0;
            
            AppState.conversations.forEach(conversation => {
                if (conversation.messages) {
                    const unread = conversation.messages.filter(m => 
                        !m.read && m.senderId === conversation.userId
                    ).length;
                    totalUnread += unread;
                }
            });
            
            AppState.unreadMessages = totalUnread;
            
            const badge = document.getElementById('messages-nav-badge');
            const countElement = document.getElementById('messages-count');
            
            if (totalUnread > 0) {
                badge.textContent = totalUnread;
                badge.classList.remove('hidden');
                countElement.textContent = totalUnread;
            } else {
                badge.classList.add('hidden');
                countElement.textContent = AppState.conversations.length;
            }
        }

        function sendMessageToUser(userId) {
            if (!AppState.currentUser) {
                showNotification('Veuillez vous connecter pour envoyer un message', 'error');
                return;
            }
            
            startConversationWithUser(userId);
        }

        // ===== MAP FUNCTIONS =====
        function initializeMap() {
            try {
                AppState.map = L.map('map').setView(CONFIG.MAHAJANGA_CENTER, CONFIG.MAP_ZOOM);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(AppState.map);
                
                addDriversToMap();
                locateUser();
                
                setTimeout(() => {
                    if (AppState.map) {
                        AppState.map.invalidateSize();
                    }
                }, 100);
                
            } catch (error) {
                console.error('Erreur carte:', error);
                showNotification('Erreur de chargement de la carte', 'error');
            }
        }

        function addDriversToMap() {
            AppState.driverMarkers.forEach(marker => marker.remove());
            AppState.driverMarkers = [];
            
            AppState.drivers.forEach(driver => {
                if (driver.status === 'available') {
                    const icon = L.divIcon({
                        html: `
                            <div style="
                                width: 40px;
                                height: 40px;
                                background: ${driver.color};
                                border-radius: 50%;
                                border: 3px solid white;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 18px;
                                color: white;
                                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                            ">
                                ${driver.type === 'tuktuk' ? '🛺' : driver.type === 'scooter' ? '🛵' : driver.type === 'van' ? '🚐' : '🚗'}
                            </div>
                        `,
                        className: 'driver-marker',
                        iconSize: [40, 40],
                        iconAnchor: [20, 40]
                    });
                    
                    const marker = L.marker([driver.lat, driver.lng], { icon: icon })
                        .addTo(AppState.map)
                        .bindPopup(`
                            <div style="min-width: 200px; font-family: -apple-system, sans-serif;">
                                <h4 style="margin: 0 0 10px 0; font-size: 16px;">${driver.name}</h4>
                                <p style="margin: 5px 0; font-size: 14px;"><strong>Véhicule:</strong> ${driver.vehicle}</p>
                                <p style="margin: 5px 0; font-size: 14px;"><strong>Type:</strong> ${driver.type === 'tuktuk' ? '🛺 TukTuk' : driver.type === 'scooter' ? '🛵 Scooter' : driver.type === 'van' ? '🚐 Van' : '🚗 Voiture'}</p>
                                <p style="margin: 5px 0; font-size: 14px;"><strong>Note:</strong> ⭐ ${driver.rating}/5</p>
                                <p style="margin: 5px 0; font-size: 14px;"><strong>Distance:</strong> ${driver.distance} km</p>
                                <p style="margin: 5px 0; font-size: 14px;"><strong>Disponibilité:</strong> ${driver.status === 'available' ? '🟢 Disponible' : '🔴 Occupé'}</p>
                                <button onclick="selectDriverFromMap(${driver.id})" 
                                        style="
                                            background: #007AFF;
                                            color: white;
                                            border: none;
                                            padding: 10px;
                                            border-radius: 8px;
                                            cursor: pointer;
                                            width: 100%;
                                            margin-top: 10px;
                                            font-size: 14px;
                                            font-weight: 600;
                                        ">
                                    <i class="fas fa-car"></i> Choisir ce chauffeur
                                </button>
                            </div>
                        `);
                    
                    AppState.driverMarkers.push(marker);
                }
            });
            
            updateDriversCount();
        }

        function locateUser() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const userPos = [position.coords.latitude, position.coords.longitude];
                        AppState.currentLocation = userPos;
                        
                        document.getElementById('pickup-input').value = "Position actuelle";
                        
                        if (AppState.userMarker) {
                            AppState.userMarker.remove();
                        }
                        
                        const userIcon = L.divIcon({
                            html: `
                                <div style="
                                    width: 30px;
                                    height: 30px;
                                    background: #007AFF;
                                    border-radius: 50%;
                                    border: 3px solid white;
                                    box-shadow: 0 0 20px #007AFF;
                                    animation: pulse 2s infinite;
                                "></div>
                            `,
                            className: 'user-marker',
                            iconSize: [30, 30],
                            iconAnchor: [15, 30]
                        });
                        
                        AppState.userMarker = L.marker(userPos, { icon: userIcon })
                            .addTo(AppState.map)
                            .bindPopup('Votre position')
                            .openPopup();
                        
                        updateUserRadiusCircle(userPos);
                        
                        AppState.map.setView(userPos, 15);
                        
                        showNotification('Position localisée avec succès', 'success');
                        updateRideEstimate();
                        
                    },
                    error => {
                        console.warn('Erreur géolocalisation:', error);
                        showNotification('Impossible de vous localiser', 'error');
                        
                        AppState.currentLocation = CONFIG.MAHAJANGA_CENTER;
                        document.getElementById('pickup-input').value = "Mahajanga Centre";
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                showNotification('La géolocalisation n\'est pas supportée', 'error');
                AppState.currentLocation = CONFIG.MAHAJANGA_CENTER;
            }
        }

        function updateUserRadiusCircle(center) {
            if (AppState.userRadiusCircle) {
                AppState.userRadiusCircle.remove();
            }
            
            AppState.userRadiusCircle = L.circle(center, {
                radius: CONFIG.USER_RADIUS_KM * 1000,
                color: '#007AFF',
                fillColor: '#007AFF',
                fillOpacity: 0.1,
                weight: 2,
                opacity: 0.5
            }).addTo(AppState.map);
            
            if (!AppState.radiusVisible) {
                AppState.userRadiusCircle.remove();
            }
            
            updateNearbyDrivers();
        }

        function toggleRadius() {
            AppState.radiusVisible = !AppState.radiusVisible;
            
            if (AppState.userRadiusCircle) {
                if (AppState.radiusVisible) {
                    AppState.userRadiusCircle.addTo(AppState.map);
                } else {
                    AppState.userRadiusCircle.remove();
                }
            }
            
            const btn = document.getElementById('toggle-radius-btn');
            if (AppState.radiusVisible) {
                btn.innerHTML = '<i class="fas fa-circle"></i>';
                btn.title = 'Masquer le cercle de 3km';
                showNotification('Cercle de 3km affiché', 'info');
            } else {
                btn.innerHTML = '<i class="far fa-circle"></i>';
                btn.title = 'Afficher le cercle de 3km';
                showNotification('Cercle de 3km masqué', 'info');
            }
        }

        function updateNearbyDrivers() {
            if (!AppState.currentLocation || !AppState.userRadiusCircle) return;
            
            const center = AppState.currentLocation;
            const radius = CONFIG.USER_RADIUS_KM;
            
            const nearbyDrivers = AppState.drivers.filter(driver => {
                if (driver.status !== 'available') return false;
                
                const distance = calculateDistance(
                    center[0], center[1],
                    driver.lat, driver.lng
                );
                
                return distance <= radius;
            });
            
            document.getElementById('drivers-count').textContent = `${nearbyDrivers.length} dans la zone`;
            
            renderDriversList();
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function getCurrentLocation() {
            showNotification('Localisation en cours...', 'info');
            locateUser();
        }

        function centerMapOnMahajanga() {
            if (AppState.map) {
                AppState.map.setView(CONFIG.MAHAJANGA_CENTER, CONFIG.MAP_ZOOM);
                showNotification('Carte centrée sur Mahajanga', 'info');
            }
        }

        function refreshMap() {
            addDriversToMap();
            if (AppState.currentLocation) {
                updateUserRadiusCircle(AppState.currentLocation);
            }
            showNotification('Carte actualisée', 'success');
        }

        function updateDriversCount() {
            if (!AppState.currentLocation) {
                document.getElementById('drivers-count').textContent = 'Localisation requise';
                return;
            }
            
            const nearbyDrivers = AppState.drivers.filter(driver => {
                if (driver.status !== 'available') return false;
                if (!AppState.currentLocation) return true;
                
                const distance = calculateDistance(
                    AppState.currentLocation[0], AppState.currentLocation[1],
                    driver.lat, driver.lng
                );
                
                return distance <= CONFIG.USER_RADIUS_KM;
            });
            
            document.getElementById('drivers-count').textContent = `${nearbyDrivers.length} dans la zone`;
        }

        function selectDriverFromMap(driverId) {
            const driver = AppState.drivers.find(d => d.id === driverId);
            if (!driver) return;
            
            showPage('ride');
            selectDriver(driver);
            
            if (AppState.map) {
                AppState.map.setView([driver.lat, driver.lng], 16);
                
                const marker = AppState.driverMarkers.find(m => {
                    const latLng = m.getLatLng();
                    return latLng.lat === driver.lat && latLng.lng === driver.lng;
                });
                if (marker) {
                    marker.openPopup();
                }
            }
        }

        function renderDriversList() {
            const container = document.getElementById('drivers-list');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!AppState.currentLocation) {
                container.innerHTML = `
                    <div class="text-center text-muted p-4">
                        <i class="fas fa-map-marker-alt" style="font-size: 36px; margin-bottom: var(--space-sm);"></i>
                        <div>Activez la localisation pour voir les chauffeurs près de vous</div>
                        <button class="btn btn-primary mt-3" onclick="locateUser()">
                            <i class="fas fa-location-crosshairs"></i>
                            Activer la localisation
                        </button>
                    </div>
                `;
                return;
            }
            
            const nearbyDrivers = AppState.drivers.filter(driver => {
                if (driver.status !== 'available') return false;
                
                const distance = calculateDistance(
                    AppState.currentLocation[0], AppState.currentLocation[1],
                    driver.lat, driver.lng
                );
                
                return distance <= CONFIG.USER_RADIUS_KM;
            });
            
            if (nearbyDrivers.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted p-4">
                        <i class="fas fa-car" style="font-size: 36px; margin-bottom: var(--space-sm);"></i>
                        <div>Aucun chauffeur disponible dans votre zone (3km)</div>
                    </div>
                `;
                return;
            }
            
            nearbyDrivers.forEach(driver => {
                const distance = calculateDistance(
                    AppState.currentLocation[0], AppState.currentLocation[1],
                    driver.lat, driver.lng
                );
                
                const driverElement = document.createElement('div');
                driverElement.className = 'driver-card';
                driverElement.onclick = () => selectDriverFromMap(driver.id);
                
                driverElement.innerHTML = `
                    <div class="driver-avatar">
                        ${driver.type === 'tuktuk' ? '🛺' : driver.type === 'scooter' ? '🛵' : driver.type === 'van' ? '🚐' : '🚗'}
                    </div>
                    <div class="driver-info">
                        <div class="driver-name">${driver.name}</div>
                        <div class="driver-vehicle">${driver.vehicle} • ${driver.plate}</div>
                        <div class="driver-rating">
                            ⭐ ${driver.rating}
                            <span class="text-muted">• ${distance.toFixed(1)} km</span>
                        </div>
                    </div>
                    <div style="color: ${driver.status === 'available' ? 'var(--success)' : 'var(--warning)'}; font-size: 12px; font-weight: 600;">
                        ${driver.status === 'available' ? '🟢' : '🔴'}
                    </div>
                `;
                container.appendChild(driverElement);
            });
        }

        // ===== PROFILE FUNCTIONS =====
        function handleAuth() {
            const role = document.getElementById('auth-role').value;
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const license = role === 'driver' ? document.getElementById('auth-license').value : null;
            const isSignUp = document.getElementById('toggle-auth-mode').textContent === 'Se connecter';
            
            if (!email || !password) {
                showNotification('Veuillez remplir tous les champs', 'error');
                return;
            }
            
            if (!validateEmail(email)) {
                showNotification('Email invalide', 'error');
                return;
            }
            
            if (password.length < 6) {
                showNotification('Le mot de passe doit contenir au moins 6 caractères', 'error');
                return;
            }
            
            if (role === 'admin' && email === CONFIG.ADMIN_CREDENTIALS.email && password === CONFIG.ADMIN_CREDENTIALS.password) {
                const adminUser = SAMPLE_USERS.find(u => u.isAdmin === true);
                if (adminUser) {
                    AppState.currentUser = adminUser;
                    AppState.isAdmin = true;
                    saveToLocalStorage();
                    
                    showNotification('Connexion admin réussie!', 'success');
                    updateUIAfterAuth();
                    return;
                }
            }
            
            if (role === 'driver' && license) {
                if (!validateLicenseNumber(license)) {
                    showNotification('Numéro de permis invalide (minimum 10 caractères)', 'error');
                    return;
                }
            }
            
            if (role === 'driver' && isSignUp) {
                showDriverRegistration();
                return;
            }
            
            const mockUser = {
                id: Date.now(),
                name: role === 'driver' ? 'Chauffeur VTC' : 'Passager VTC',
                email: email,
                phone: '+261 34 ' + Math.floor(Math.random() * 100) + ' ' + Math.floor(Math.random() * 100) + ' ' + Math.floor(Math.random() * 100),
                avatar: '👤',
                bio: role === 'driver' ? 'Chauffeur professionnel' : 'Passager régulier',
                followers: Math.floor(Math.random() * 100),
                following: Math.floor(Math.random() * 50),
                posts: Math.floor(Math.random() * 20),
                isFollowing: false,
                isDriver: role === 'driver',
                isAdmin: false,
                isRealUser: true,
                joinDate: new Date().toLocaleDateString('fr-FR'),
                wallet: AppState.wallet,
                licenseNumber: license || null,
                status: 'active',
                lastLogin: new Date().toISOString()
            };
            
            AppState.currentUser = mockUser;
            AppState.isAdmin = false;
            saveToLocalStorage();
            
            showNotification(isSignUp ? 'Compte créé avec succès!' : 'Connexion réussie!', 'success');
            
            updateUIAfterAuth();
        }

        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function validateLicenseNumber(license) {
            const cleanLicense = license.replace(/\s+/g, '');
            if (cleanLicense.length < 10) {
                return false;
            }
            return true;
        }

        function toggleAuthMode() {
            const btn = document.getElementById('toggle-auth-mode');
            const authBtn = document.getElementById('auth-btn');
            
            if (btn.textContent === 'Créer un compte') {
                btn.textContent = 'Se connecter';
                authBtn.innerHTML = '<i class="fas fa-user-plus"></i> Créer un compte';
            } else {
                btn.textContent = 'Créer un compte';
                authBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Se connecter';
            }
        }

        function checkAuth() {
            const savedUser = localStorage.getItem('vtc_user');
            if (savedUser) {
                try {
                    AppState.currentUser = JSON.parse(savedUser);
                    AppState.isAdmin = AppState.currentUser && AppState.currentUser.isAdmin === true;
                    updateUIAfterAuth();
                } catch (error) {
                    console.error('Erreur chargement utilisateur:', error);
                }
            }
        }

        function updateUIAfterAuth() {
            if (!AppState.currentUser) return;
            
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('profile-section').classList.remove('hidden');
            
            updateProfileDisplay();
            updatePostCount();
            updateFollowersCount();
            updateOrdersCount();
            updateMessagesCount();
            updateWalletUI();
            renderOrderHistory();
            updateRecentOrders();
            
            updateAvatarDisplay(AppState.currentUser.avatar);
            
            const adminBtn = document.getElementById('admin-btn');
            if (AppState.isAdmin) {
                adminBtn.classList.remove('hidden');
            } else {
                adminBtn.classList.add('hidden');
            }
            
            if (AppState.currentUser.isDriver) {
                AppState.driverMode = true;
                showNotification('Mode chauffeur activé', 'success');
            }
        }

        function updateProfileDisplay() {
            if (!AppState.currentUser) return;
            
            document.getElementById('profile-name').textContent = AppState.currentUser.name;
            document.getElementById('profile-bio').textContent = AppState.currentUser.bio || 'Aucune bio';
            
            const profileAvatar = document.getElementById('profile-avatar');
            if (AppState.currentUser.avatar && AppState.currentUser.avatar.startsWith('data:image')) {
                profileAvatar.innerHTML = `<img src="${AppState.currentUser.avatar}" alt="Avatar" style="width:100%;height:100%;object-fit:cover;"><div class="avatar-edit-overlay"><i class="fas fa-camera"></i> Changer</div>`;
            } else {
                profileAvatar.innerHTML = `${AppState.currentUser.avatar || '👤'}<div class="avatar-edit-overlay"><i class="fas fa-camera"></i> Changer</div>`;
            }
        }

        function editProfile() {
            if (!AppState.currentUser) return;
            
            document.getElementById('edit-name-input').value = AppState.currentUser.name;
            document.getElementById('edit-phone-input').value = AppState.currentUser.phone || '';
            document.getElementById('edit-bio-input').value = AppState.currentUser.bio || '';
            
            document.getElementById('edit-profile-modal').classList.remove('hidden');
        }

        function saveProfileChanges() {
            const name = document.getElementById('edit-name-input').value.trim();
            const phone = document.getElementById('edit-phone-input').value.trim();
            const bio = document.getElementById('edit-bio-input').value.trim();
            
            if (!name) {
                showNotification('Le nom est requis', 'error');
                return;
            }
            
            if (AppState.currentUser) {
                AppState.currentUser.name = name;
                AppState.currentUser.phone = phone;
                AppState.currentUser.bio = bio;
                
                saveToLocalStorage();
                
                updateProfileDisplay();
                closeEditProfileModal();
                showNotification('Profil mis à jour avec succès', 'success');
            }
        }

        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showNotification('Veuillez sélectionner une image', 'error');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showNotification('L\'image est trop volumineuse (max 5MB)', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                if (AppState.currentUser) {
                    AppState.currentUser.avatar = e.target.result;
                    
                    saveToLocalStorage();
                    
                    updateAvatarDisplay(e.target.result);
                    
                    showNotification('Photo de profil mise à jour', 'success');
                }
            };
            reader.readAsDataURL(file);
        }

        function changeAvatar() {
            document.getElementById('avatar-input').click();
        }

        function logout() {
            if (confirm('Voulez-vous vraiment vous déconnecter ?')) {
                localStorage.removeItem('vtc_user');
                
                AppState.currentUser = null;
                AppState.driverMode = false;
                AppState.isAdmin = false;
                
                saveToLocalStorage();
                
                showPage('profile');
                
                document.getElementById('auth-section').classList.remove('hidden');
                document.getElementById('profile-section').classList.add('hidden');
                document.getElementById('admin-panel').classList.add('hidden');
                
                document.getElementById('header-avatar').innerHTML = '👤';
                document.getElementById('current-user-avatar').innerHTML = '👤';
                
                showNotification('Déconnexion réussie', 'success');
            }
        }

        // ===== INSCRIPTION CHAUFFEUR =====
        function showDriverRegistration() {
            document.getElementById('driver-registration-modal').classList.remove('hidden');
        }

        function closeDriverRegistration() {
            document.getElementById('driver-registration-modal').classList.add('hidden');
        }

        function registerDriver() {
            const name = document.getElementById('driver-name').value.trim();
            const email = document.getElementById('driver-email').value.trim();
            const phone = document.getElementById('driver-phone').value.trim();
            const license = document.getElementById('driver-license').value.trim();
            const vehicle = document.getElementById('driver-vehicle').value.trim();
            const plate = document.getElementById('driver-plate').value.trim();
            const password = document.getElementById('driver-password').value;
            const confirmPassword = document.getElementById('driver-confirm-password').value;
            
            if (!name || !email || !phone || !license || !vehicle || !plate || !password) {
                showNotification('Tous les champs sont obligatoires', 'error');
                return;
            }
            
            if (!validateEmail(email)) {
                showNotification('Email invalide', 'error');
                return;
            }
            
            if (!validateLicenseNumber(license)) {
                showNotification('Numéro de permis invalide (minimum 10 caractères)', 'error');
                return;
            }
            
            if (password.length < 6) {
                showNotification('Le mot de passe doit contenir au moins 6 caractères', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showNotification('Les mots de passe ne correspondent pas', 'error');
                return;
            }
            
            const driverUser = {
                id: Date.now(),
                name: name,
                email: email,
                phone: phone,
                avatar: '🚗',
                bio: `Chauffeur VTC - ${vehicle}`,
                followers: 0,
                following: 0,
                posts: 0,
                isFollowing: false,
                isDriver: true,
                isAdmin: false,
                isRealUser: true,
                joinDate: new Date().toLocaleDateString('fr-FR'),
                wallet: 0,
                licenseNumber: license,
                vehicle: vehicle,
                plate: plate,
                status: 'active',
                lastLogin: new Date().toISOString()
            };
            
            AppState.currentUser = driverUser;
            AppState.isAdmin = false;
            saveToLocalStorage();
            
            closeDriverRegistration();
            updateUIAfterAuth();
            
            const vehicleType = vehicle.toLowerCase().includes('tuktuk') ? 'tuktuk' :
                              vehicle.toLowerCase().includes('scooter') ? 'scooter' :
                              vehicle.toLowerCase().includes('van') ? 'van' : 'car';
            
            const newDriver = {
                id: driverUser.id,
                name: driverUser.name,
                vehicle: driverUser.vehicle,
                plate: driverUser.plate,
                rating: 4.5,
                lat: CONFIG.MAHAJANGA_CENTER[0] + (Math.random() - 0.5) * 0.01,
                lng: CONFIG.MAHAJANGA_CENTER[1] + (Math.random() - 0.5) * 0.01,
                status: 'available',
                phone: driverUser.phone,
                photo: '🚗',
                type: vehicleType,
                priceMultiplier: 1.0,
                distance: 0.5 + Math.random() * 2,
                eta: 3 + Math.floor(Math.random() * 5),
                color: vehicleType === 'tuktuk' ? '#FF9500' : 
                       vehicleType === 'scooter' ? '#34C759' : 
                       vehicleType === 'van' ? '#5856D6' : '#007AFF'
            };
            
            AppState.drivers.push(newDriver);
            AppState.adminData.drivers.push(newDriver);
            AppState.adminData.users.push(driverUser);
            
            updateAdminStats();
            
            showNotification('Inscription réussie ! Vous êtes maintenant chauffeur VTC.', 'success');
        }

        // ===== WALLET FUNCTIONS =====
        function showAddMoneyModal() {
            document.getElementById('add-money-modal').classList.remove('hidden');
        }

        function closeAddMoneyModal() {
            document.getElementById('add-money-modal').classList.add('hidden');
            document.getElementById('add-money-amount').value = '';
        }

        function addMoneyToWallet() {
            const amount = parseInt(document.getElementById('add-money-amount').value);
            
            if (!amount || amount < 1000) {
                showNotification('Montant minimum: 1 000 Ar', 'error');
                return;
            }
            
            if (amount > 1000000) {
                showNotification('Montant maximum: 1 000 000 Ar', 'error');
                return;
            }
            
            AppState.wallet += amount;
            saveToLocalStorage();
            updateWalletUI();
            
            addNotification({
                id: Date.now(),
                type: 'wallet_recharge',
                title: 'Recharge réussie',
                message: `${formatPrice(amount)} ajoutés à votre portefeuille`,
                time: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
                read: false
            });
            
            closeAddMoneyModal();
            showNotification(`${formatPrice(amount)} ajoutés à votre portefeuille`, 'success');
        }

        function updateWalletUI() {
            document.getElementById('home-wallet').textContent = formatPrice(AppState.wallet);
            document.getElementById('profile-wallet').textContent = formatPrice(AppState.wallet);
            
            if (AppState.currentUser) {
                AppState.currentUser.wallet = AppState.wallet;
            }
        }

        // ===== ORDER FUNCTIONS =====
        function checkout() {
            if (AppState.cart.length === 0) {
                showNotification('Votre panier est vide', 'error');
                return;
            }
            
            const subtotal = AppState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            if (subtotal < CONFIG.DELIVERY_RATES.min_order) {
                showNotification(`Minimum de commande: ${formatPrice(CONFIG.DELIVERY_RATES.min_order)}`, 'error');
                return;
            }
            
            const total = subtotal + AppState.deliveryPrice;
            
            if (AppState.wallet < total) {
                showNotification('Fonds insuffisants. Veuillez recharger votre portefeuille.', 'error');
                showAddMoneyModal();
                return;
            }
            
            AppState.wallet -= total;
            saveToLocalStorage();
            updateWalletUI();
            
            const order = {
                id: Date.now(),
                type: 'shop',
                date: new Date().toLocaleDateString('fr-FR'),
                items: [...AppState.cart],
                subtotal: subtotal,
                delivery: AppState.deliveryPrice,
                total: total,
                status: 'preparing',
                deliveryTime: Math.floor(Math.random() * 10 + 20)
            };
            
            AppState.orders.unshift(order);
            AppState.adminData.orders.unshift(order);
            saveToLocalStorage();
            
            addNotification({
                id: Date.now(),
                type: 'order_confirmed',
                title: 'Commande confirmée',
                message: `Votre commande #${order.id.toString().slice(-6)} a été confirmée`,
                time: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
                read: false
            });
            
            AppState.cart = [];
            AppState.deliveryPrice = 0;
            saveToLocalStorage();
            updateCartUI();
            updateAdminStats();
            
            showCheckoutConfirmation(order);
        }

        function showCheckoutConfirmation(order) {
            document.getElementById('order-number').textContent = `#${order.id.toString().slice(-6)}`;
            document.getElementById('order-date').textContent = order.date;
            document.getElementById('order-total').textContent = formatPrice(order.total);
            document.getElementById('delivery-time').textContent = `${order.deliveryTime} minutes`;
            
            document.getElementById('checkout-modal').classList.remove('hidden');
        }

        function closeCheckoutModal() {
            document.getElementById('checkout-modal').classList.add('hidden');
            showPage('home');
        }

        function updateOrdersUI() {
            updateOrdersCount();
            renderOrderHistory();
            updateRecentOrders();
        }

        function renderOrderHistory() {
            const container = document.getElementById('orders-container');
            if (!container) return;
            
            if (AppState.orders.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted p-4">
                        <i class="fas fa-history" style="font-size: 36px; margin-bottom: var(--space-sm);"></i>
                        <div>Aucune commande passée</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            AppState.orders.slice(0, 10).forEach(order => {
                const orderElement = document.createElement('div');
                orderElement.className = 'order-item';
                
                let title = '';
                let details = '';
                
                if (order.type === 'ride') {
                    title = `Course #${order.id.toString().slice(-6)}`;
                    details = order.details;
                } else {
                    title = `Commande #${order.id.toString().slice(-6)}`;
                    details = `${order.items ? order.items.length : 0} article(s)`;
                }
                
                const statusClass = order.status === 'completed' ? 'status-completed' :
                                  order.status === 'active' ? 'status-active' :
                                  order.status === 'preparing' ? 'status-preparing' :
                                  order.status === 'pending' ? 'status-pending' :
                                  'status-cancelled';
                
                const statusText = order.status === 'completed' ? 'Terminée' :
                                 order.status === 'active' ? 'En cours' :
                                 order.status === 'preparing' ? 'En préparation' :
                                 order.status === 'pending' ? 'En attente' :
                                 'Annulée';
                
                orderElement.innerHTML = `
                    <div class="order-info">
                        <div class="order-title">${title}</div>
                        <div class="order-details">${order.date} • ${details}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 700; font-size: 16px; color: ${order.amount && order.amount < 0 ? 'var(--danger)' : 'var(--success)'}">
                            ${order.amount ? (order.amount < 0 ? '-' : '+') : ''}${formatPrice(Math.abs(order.total || order.amount || 0))}
                        </div>
                        <div class="order-status ${statusClass}">
                            ${statusText}
                        </div>
                    </div>
                `;
                container.appendChild(orderElement);
            });
        }

        function updateRecentOrders() {
            const container = document.getElementById('recent-orders');
            if (!container) return;
            
            const recentOrders = AppState.orders.slice(0, 3);
            
            if (recentOrders.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted p-3">
                        <div>Aucune commande récente</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            recentOrders.forEach(order => {
                const orderElement = document.createElement('div');
                orderElement.className = 'order-item';
                
                let title = order.type === 'ride' ? 'Course' : 'Commande';
                
                orderElement.innerHTML = `
                    <div class="order-info">
                        <div class="order-title">${title} #${order.id.toString().slice(-6)}</div>
                        <div class="order-details">${order.date}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 700; font-size: 16px; color: var(--primary)">
                            ${formatPrice(order.total || Math.abs(order.amount) || 0)}
                        </div>
                        <div class="order-status ${order.status === 'completed' ? 'status-completed' : order.status === 'active' ? 'status-active' : 'status-preparing'}">
                            ${order.status === 'completed' ? 'Terminée' : order.status === 'active' ? 'En cours' : 'En préparation'}
                        </div>
                    </div>
                `;
                container.appendChild(orderElement);
            });
        }

        function refreshOrders() {
            renderOrderHistory();
            showNotification('Historique actualisée', 'success');
        }

        // ===== NOTIFICATION FUNCTIONS =====
        function loadNotifications() {
            if (AppState.notifications.length === 0) {
                AppState.notifications = [
                    {
                        id: 1,
                        type: 'welcome',
                        title: 'Bienvenue !',
                        message: 'Bienvenue sur VTC Mahajanga. Découvrez toutes nos fonctionnalités.',
                        time: '09:00',
                        read: false
                    },
                    {
                        id: 2,
                        type: 'promotion',
                        title: 'Promotion spéciale',
                        message: '-20% sur les courses vers l\'aéroport ce week-end !',
                        time: '10:30',
                        read: false
                    },
                    {
                        id: 3,
                        type: 'update',
                        title: 'Nouvelle fonctionnalité',
                        message: 'La boutique est maintenant disponible ! Commandez de la nourriture et des accessoires.',
                        time: '14:15',
                        read: true
                    }
                ];
                saveToLocalStorage();
            }
            
            updateNotifications();
        }

        function addNotification(notification) {
            AppState.notifications.unshift(notification);
            saveToLocalStorage();
            updateNotifications();
        }

        function updateNotifications() {
            const unreadCount = AppState.notifications.filter(n => !n.read).length;
            const badge = document.getElementById('notification-badge');
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function showNotifications() {
            const modal = document.getElementById('notifications-modal');
            const list = document.getElementById('notifications-list');
            
            list.innerHTML = '';
            
            if (AppState.notifications.length === 0) {
                list.innerHTML = `
                    <div class="text-center text-muted p-4">
                        <i class="fas fa-bell-slash" style="font-size: 36px; margin-bottom: var(--space-sm);"></i>
                        <div>Aucune notification</div>
                    </div>
                `;
            } else {
                AppState.notifications.forEach(notification => {
                    const notificationElement = document.createElement('div');
                    notificationElement.className = 'order-item';
                    notificationElement.style.cursor = 'pointer';
                    notificationElement.onclick = () => markNotificationAsRead(notification.id);
                    
                    notificationElement.innerHTML = `
                        <div class="order-info">
                            <div class="order-title">${notification.title}</div>
                            <div class="order-details">${notification.message}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">${notification.time}</div>
                        </div>
                        ${!notification.read ? '<div style="width: 8px; height: 8px; background: var(--primary); border-radius: 50%;"></div>' : ''}
                    `;
                    list.appendChild(notificationElement);
                });
            }
            
            modal.classList.remove('hidden');
        }

        function markNotificationAsRead(id) {
            const notification = AppState.notifications.find(n => n.id === id);
            if (notification && !notification.read) {
                notification.read = true;
                saveToLocalStorage();
                updateNotifications();
                
                showNotifications();
            }
        }

        function closeNotificationsModal() {
            document.getElementById('notifications-modal').classList.add('hidden');
        }

        // ===== CART MODAL FUNCTIONS =====
        function showCartModal() {
            updateModalCart();
            document.getElementById('cart-modal').classList.remove('hidden');
        }

        function closeCartModal() {
            document.getElementById('cart-modal').classList.add('hidden');
        }

        function goToCheckout() {
            closeCartModal();
            showPage('shop');
        }

        // ===== UTILITY FUNCTIONS =====
        function showPage(pageName) {
            pauseAllVideos();
            cleanupVideoPlayers();
            
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const pageElement = document.getElementById(pageName + '-page');
            if (pageElement) {
                pageElement.classList.add('active');
            }
            
            const tabElement = document.querySelector(`.nav-tab[data-page="${pageName}"]`);
            if (tabElement) {
                tabElement.classList.add('active');
            }
            
            if (pageName === 'map' && AppState.map) {
                setTimeout(() => {
                    AppState.map.invalidateSize();
                    if (AppState.currentLocation) {
                        updateUserRadiusCircle(AppState.currentLocation);
                    }
                }, 100);
            }
            
            if (pageName === 'shop') {
                updateCartUI();
            }
            
            if (pageName === 'profile' && AppState.currentUser) {
                updateUIAfterAuth();
            }
            
            if (pageName === 'home') {
                updateRecentOrders();
                renderRecentPosts();
            }
            
            if (pageName === 'messages') {
                renderConversations();
                renderSuggestedUsers();
            }
            
            setTimeout(initVideoPlayers, 300);
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'error' ? 'var(--danger)' : type === 'success' ? 'var(--success)' : type === 'warning' ? 'var(--warning)' : 'var(--primary)'};
                color: white;
                padding: 12px 20px;
                border-radius: var(--radius-md);
                box-shadow: var(--shadow-lg);
                z-index: 2000;
                animation: slideInBottom 0.3s ease;
                display: flex;
                align-items: center;
                gap: 10px;
                max-width: 90%;
                font-size: 14px;
                font-weight: 500;
            `;
            
            const icon = type === 'error' ? 'exclamation-circle' :
                        type === 'success' ? 'check-circle' :
                        type === 'warning' ? 'exclamation-triangle' : 'info-circle';
            
            notification.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideInBottom 0.3s ease reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('fr-MG', {
                style: 'currency',
                currency: 'MGA',
                minimumFractionDigits: 0
            }).format(price).replace('MGA', 'Ar');
        }

        function updateAvatarDisplay(avatarData) {
            const avatarElements = [
                {el: document.getElementById('profile-avatar'), isLarge: true},
                {el: document.getElementById('header-avatar'), isLarge: false},
                {el: document.getElementById('current-user-avatar'), isLarge: false}
            ];
            
            avatarElements.forEach(item => {
                if (item.el) {
                    if (avatarData && avatarData.startsWith('data:image')) {
                        if (item.isLarge) {
                            item.el.innerHTML = `<img src="${avatarData}" alt="Avatar" style="width:100%;height:100%;object-fit:cover;"><div class="avatar-edit-overlay"><i class="fas fa-camera"></i> Changer</div>`;
                        } else {
                            item.el.innerHTML = `<img src="${avatarData}" alt="Avatar" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
                        }
                    } else {
                        if (item.isLarge) {
                            item.el.innerHTML = `${avatarData || '👤'}<div class="avatar-edit-overlay"><i class="fas fa-camera"></i> Changer</div>`;
                        } else {
                            item.el.textContent = avatarData || '👤';
                        }
                    }
                }
            });
        }

        function updatePostCount() {
            if (!AppState.currentUser) return;
            const userPosts = AppState.posts.filter(p => p.userId === AppState.currentUser.id);
            document.getElementById('posts-count').textContent = userPosts.length;
        }

        function updateFollowersCount() {
            if (!AppState.currentUser) return;
            document.getElementById('followers-count').textContent = AppState.currentUser.followers || 0;
        }

        function updateOrdersCount() {
            document.getElementById('orders-count').textContent = AppState.orders.length;
        }

        function showUserPosts() {
            showNotification('Fonctionnalité en développement', 'info');
        }

        function showFollowers() {
            showNotification('Fonctionnalité en développement', 'info');
        }

        function showOrderHistory() {
        }

        function quickRide(type) {
            showPage('ride');
            selectRideType(type);
        }

        function startRealTimeUpdates() {
            setInterval(() => {
                if (AppState.drivers.length > 0) {
                    AppState.drivers.forEach(driver => {
                        if (driver.status === 'available') {
                            driver.lat += (Math.random() - 0.5) * 0.001;
                            driver.lng += (Math.random() - 0.5) * 0.001;
                        }
                    });
                    
                    if (document.getElementById('map-page').classList.contains('active')) {
                        addDriversToMap();
                        updateNearbyDrivers();
                    }
                }
            }, 30000);
            
            setInterval(() => {
                AppState.drivers.forEach(driver => {
                    if (Math.random() > 0.7) {
                        driver.status = driver.status === 'available' ? 'busy' : 'available';
                    }
                });
            }, 60000);
        }

        function checkGeolocation() {
            if (!navigator.geolocation) {
                showNotification('La géolocalisation n\'est pas disponible sur votre appareil', 'warning');
            }
        }

        // ===== ADMIN FUNCTIONS =====
        function showAdminPanel() {
            const adminPanel = document.getElementById('admin-panel');
            if (adminPanel.classList.contains('hidden')) {
                adminPanel.classList.remove('hidden');
                refreshAdminData();
                showAdminTab('dashboard');
            } else {
                adminPanel.classList.add('hidden');
            }
        }

        function showAdminTab(tabName) {
            document.querySelectorAll('.admin-section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(`admin-${tabName}`).classList.add('active');
            document.querySelector(`.admin-tab[onclick*="${tabName}"]`).classList.add('active');
            
            switch(tabName) {
                case 'dashboard':
                    loadAdminDashboard();
                    break;
                case 'users':
                    loadAdminUsers();
                    break;
                case 'drivers':
                    loadAdminDrivers();
                    break;
                case 'orders':
                    loadAdminOrders();
                    break;
                case 'posts':
                    loadAdminPosts();
                    break;
                case 'messages':
                    loadAdminMessages();
                    break;
            }
        }

        function refreshAdminData() {
            updateAdminStats();
            loadAdminDashboard();
        }

        function updateAdminStats() {
            const today = new Date().toLocaleDateString('fr-FR');
            
            AppState.adminData.stats = {
                totalUsers: AppState.adminData.users.length,
                totalDrivers: AppState.adminData.drivers.length,
                totalOrders: AppState.adminData.orders.length,
                totalPosts: AppState.adminData.posts.length,
                totalMessages: AppState.adminData.messages.length,
                todayOrders: AppState.adminData.orders.filter(o => o.date === today).length,
                todayRevenue: AppState.adminData.orders
                    .filter(o => o.date === today)
                    .reduce((sum, o) => sum + (o.total || Math.abs(o.amount) || 0), 0),
                activeUsers: AppState.adminData.users.filter(u => u.status === 'active').length
            };
            
            document.getElementById('admin-total-users').textContent = AppState.adminData.stats.totalUsers;
            document.getElementById('admin-total-drivers').textContent = AppState.adminData.stats.totalDrivers;
            document.getElementById('admin-total-orders').textContent = AppState.adminData.stats.totalOrders;
            document.getElementById('admin-total-posts').textContent = AppState.adminData.stats.totalPosts;
            document.getElementById('admin-total-messages').textContent = AppState.adminData.stats.totalMessages;
            document.getElementById('admin-today-orders').textContent = AppState.adminData.stats.todayOrders;
            document.getElementById('admin-today-revenue').textContent = formatPrice(AppState.adminData.stats.todayRevenue);
            document.getElementById('admin-active-users').textContent = AppState.adminData.stats.activeUsers;
        }

        function loadAdminDashboard() {
        }

        function loadAdminUsers() {
            const table = document.getElementById('admin-users-table');
            table.innerHTML = '';
            
            AppState.adminData.users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            ${user.avatar}
                            <div>
                                <div style="font-weight: 600;">${user.name}</div>
                                <div style="font-size: 10px; color: var(--text-secondary);">@${user.username}</div>
                            </div>
                        </div>
                    </td>
                    <td>${user.email}</td>
                    <td>
                        ${user.isAdmin ? '<span style="color: var(--admin-color);">👑 Admin</span>' : 
                          user.isDriver ? '<span style="color: var(--primary);">🚗 Chauffeur</span>' : 
                          '<span style="color: var(--text-secondary);">👤 Passager</span>'}
                    </td>
                    <td>
                        <button class="admin-action-btn ${user.status === 'active' ? 'block' : 'approve'}" 
                                onclick="toggleUserStatus(${user.id})">
                            ${user.status === 'active' ? 'Bloquer' : 'Activer'}
                        </button>
                        ${!user.isAdmin ? `
                            <button class="admin-action-btn edit" onclick="editUser(${user.id})">
                                Modifier
                            </button>
                        ` : ''}
                    </td>
                `;
                table.appendChild(row);
            });
        }

        function loadAdminDrivers() {
            const table = document.getElementById('admin-drivers-table');
            table.innerHTML = '';
            
            AppState.adminData.drivers.forEach(driver => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            ${driver.type === 'tuktuk' ? '🛺' : driver.type === 'scooter' ? '🛵' : driver.type === 'van' ? '🚐' : '🚗'}
                            <div>
                                <div style="font-weight: 600;">${driver.name}</div>
                                <div style="font-size: 10px; color: var(--text-secondary);">${driver.plate}</div>
                            </div>
                        </div>
                    </td>
                    <td>${driver.vehicle}</td>
                    <td>⭐ ${driver.rating}</td>
                    <td>
                        <span style="color: ${driver.status === 'available' ? 'var(--success)' : 'var(--warning)'};">
                            ${driver.status === 'available' ? '🟢 Disponible' : '🔴 Occupé'}
                        </span>
                    </td>
                    <td>
                        <button class="admin-action-btn ${driver.status === 'available' ? 'block' : 'approve'}" 
                                onclick="toggleDriverStatus(${driver.id})">
                            ${driver.status === 'available' ? 'Désactiver' : 'Activer'}
                        </button>
                        <button class="admin-action-btn delete" onclick="deleteDriver(${driver.id})">
                            Supprimer
                        </button>
                    </td>
                `;
                table.appendChild(row);
            });
        }

        function loadAdminOrders() {
            const table = document.getElementById('admin-orders-table');
            table.innerHTML = '';
            
            AppState.adminData.orders.slice(0, 10).forEach(order => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>#${order.id.toString().slice(-6)}</td>
                    <td>${order.type === 'ride' ? '🚗 Course' : '🛒 Commande'}</td>
                    <td>${formatPrice(order.total || Math.abs(order.amount) || 0)}</td>
                    <td>
                        <span class="order-status ${order.status === 'completed' ? 'status-completed' : 
                                                   order.status === 'active' ? 'status-active' : 
                                                   order.status === 'preparing' ? 'status-preparing' : 
                                                   order.status === 'pending' ? 'status-pending' : 'status-cancelled'}">
                            ${order.status === 'completed' ? 'Terminée' : 
                             order.status === 'active' ? 'En cours' : 
                             order.status === 'preparing' ? 'En préparation' : 
                             order.status === 'pending' ? 'En attente' : 'Annulée'}
                        </span>
                    </td>
                    <td>
                        <button class="admin-action-btn edit" onclick="viewOrder(${order.id})">
                            Voir
                        </button>
                        <button class="admin-action-btn ${order.status === 'completed' || order.status === 'cancelled' ? 'approve' : 'delete'}" 
                                onclick="${order.status === 'completed' || order.status === 'cancelled' ? 'completeOrder' : 'cancelOrder'}(${order.id})">
                            ${order.status === 'completed' || order.status === 'cancelled' ? 'Terminer' : 'Annuler'}
                        </button>
                    </td>
                `;
                table.appendChild(row);
            });
        }

        function loadAdminPosts() {
            const table = document.getElementById('admin-posts-table');
            table.innerHTML = '';
            
            AppState.adminData.posts.slice(0, 10).forEach(post => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            ${post.userAvatar}
                            <div>
                                <div style="font-weight: 600;">${post.userName}</div>
                                <div style="font-size: 10px; color: var(--text-secondary);">${post.timestamp}</div>
                            </div>
                        </div>
                    </td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                        ${post.content.length > 50 ? post.content.substring(0, 50) + '...' : post.content}
                    </td>
                    <td>${post.likes} ❤️</td>
                    <td>
                        <button class="admin-action-btn ${post.status === 'active' ? 'block' : 'approve'}" 
                                onclick="togglePostStatus(${post.id})">
                            ${post.status === 'active' ? 'Masquer' : 'Afficher'}
                        </button>
                        <button class="admin-action-btn delete" onclick="deletePost(${post.id})">
                            Supprimer
                        </button>
                    </td>
                `;
                table.appendChild(row);
            });
        }

        function loadAdminMessages() {
            const table = document.getElementById('admin-messages-table');
            table.innerHTML = '';
            
            AppState.adminData.messages.slice(0, 10).forEach(message => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${message.from}</td>
                    <td>${message.to}</td>
                    <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">
                        ${message.message.length > 30 ? message.message.substring(0, 30) + '...' : message.message}
                    </td>
                    <td>${message.time}</td>
                    <td>
                        <button class="admin-action-btn edit" onclick="viewMessage(${message.id})">
                            Voir
                        </button>
                        <button class="admin-action-btn delete" onclick="deleteMessage(${message.id})">
                            Supprimer
                        </button>
                    </td>
                `;
                table.appendChild(row);
            });
        }

        function searchUsers(query) {
            if (!query) {
                loadAdminUsers();
                return;
            }
            
            const filteredUsers = AppState.adminData.users.filter(user =>
                user.name.toLowerCase().includes(query.toLowerCase()) ||
                user.email.toLowerCase().includes(query.toLowerCase()) ||
                user.username.toLowerCase().includes(query.toLowerCase())
            );
            
            const table = document.getElementById('admin-users-table');
            table.innerHTML = '';
            
            filteredUsers.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            ${user.avatar}
                            <div>
                                <div style="font-weight: 600;">${user.name}</div>
                                <div style="font-size: 10px; color: var(--text-secondary);">@${user.username}</div>
                            </div>
                        </div>
                    </td>
                    <td>${user.email}</td>
                    <td>
                        ${user.isAdmin ? '<span style="color: var(--admin-color);">👑 Admin</span>' : 
                          user.isDriver ? '<span style="color: var(--primary);">🚗 Chauffeur</span>' : 
                          '<span style="color: var(--text-secondary);">👤 Passager</span>'}
                    </td>
                    <td>
                        <button class="admin-action-btn ${user.status === 'active' ? 'block' : 'approve'}" 
                                onclick="toggleUserStatus(${user.id})">
                            ${user.status === 'active' ? 'Bloquer' : 'Activer'}
                        </button>
                        ${!user.isAdmin ? `
                            <button class="admin-action-btn edit" onclick="editUser(${user.id})">
                                Modifier
                            </button>
                        ` : ''}
                    </td>
                `;
                table.appendChild(row);
            });
        }

        function toggleUserStatus(userId) {
            const user = AppState.adminData.users.find(u => u.id === userId);
            if (!user) return;
            
            user.status = user.status === 'active' ? 'blocked' : 'active';
            
            const mainUser = AppState.users.find(u => u.id === userId);
            if (mainUser) {
                mainUser.status = user.status;
            }
            
            showNotification(`Utilisateur ${user.status === 'active' ? 'activé' : 'bloqué'}`, 'success');
            loadAdminUsers();
            updateAdminStats();
        }

        function toggleDriverStatus(driverId) {
            const driver = AppState.adminData.drivers.find(d => d.id === driverId);
            if (!driver) return;
            
            driver.status = driver.status === 'available' ? 'busy' : 'available';
            
            const mainDriver = AppState.drivers.find(d => d.id === driverId);
            if (mainDriver) {
                mainDriver.status = driver.status;
            }
            
            showNotification(`Chauffeur ${driver.status === 'available' ? 'activé' : 'désactivé'}`, 'success');
            loadAdminDrivers();
            addDriversToMap();
        }

        function togglePostStatus(postId) {
            const post = AppState.adminData.posts.find(p => p.id === postId);
            if (!post) return;
            
            post.status = post.status === 'active' ? 'hidden' : 'active';
            
            const mainPost = AppState.posts.find(p => p.id === postId);
            if (mainPost) {
                mainPost.status = post.status;
            }
            
            showNotification(`Publication ${post.status === 'active' ? 'affichée' : 'masquée'}`, 'success');
            loadAdminPosts();
            renderPosts();
            renderRecentPosts();
        }

        function deleteDriver(driverId) {
            if (confirm('Voulez-vous vraiment supprimer ce chauffeur ?')) {
                AppState.adminData.drivers = AppState.adminData.drivers.filter(d => d.id !== driverId);
                AppState.drivers = AppState.drivers.filter(d => d.id !== driverId);
                
                showNotification('Chauffeur supprimé', 'success');
                loadAdminDrivers();
                addDriversToMap();
                updateAdminStats();
            }
        }

        function deletePost(postId) {
            if (confirm('Voulez-vous vraiment supprimer cette publication ?')) {
                AppState.adminData.posts = AppState.adminData.posts.filter(p => p.id !== postId);
                AppState.posts = AppState.posts.filter(p => p.id !== postId);
                
                showNotification('Publication supprimée', 'success');
                loadAdminPosts();
                renderPosts();
                renderRecentPosts();
                updateAdminStats();
            }
        }

        function deleteMessage(messageId) {
            if (confirm('Voulez-vous vraiment supprimer ce message ?')) {
                AppState.adminData.messages = AppState.adminData.messages.filter(m => m.id !== messageId);
                
                showNotification('Message supprimé', 'success');
                loadAdminMessages();
                updateAdminStats();
            }
        }

        function editUser(userId) {
            showNotification('Fonctionnalité en développement', 'info');
        }

        function viewOrder(orderId) {
            showNotification('Fonctionnalité en développement', 'info');
        }

        function viewMessage(messageId) {
            showNotification('Fonctionnalité en développement', 'info');
        }

        function completeOrder(orderId) {
            const order = AppState.adminData.orders.find(o => o.id === orderId);
            if (!order) return;
            
            order.status = 'completed';
            
            const mainOrder = AppState.orders.find(o => o.id === orderId);
            if (mainOrder) {
                mainOrder.status = 'completed';
            }
            
            showNotification('Commande terminée', 'success');
            loadAdminOrders();
            saveToLocalStorage();
        }

        function cancelOrder(orderId) {
            const order = AppState.adminData.orders.find(o => o.id === orderId);
            if (!order) return;
            
            order.status = 'cancelled';
            
            const mainOrder = AppState.orders.find(o => o.id === orderId);
            if (mainOrder) {
                mainOrder.status = 'cancelled';
            }
            
            showNotification('Commande annulée', 'success');
            loadAdminOrders();
            saveToLocalStorage();
        }

        function closeAdminModal() {
            document.getElementById('admin-modal').classList.add('hidden');
        }

        // ===== MODAL CLOSE FUNCTIONS =====
        function closeUserProfileModal() {
            document.getElementById('user-profile-modal').classList.add('hidden');
        }

        function closeEditProfileModal() {
            document.getElementById('edit-profile-modal').classList.add('hidden');
        }

        function closeReportModal() {
            document.getElementById('report-modal').classList.add('hidden');
        }

        // ===== SOCIAL FUNCTIONS (suite) =====
        function showUserProfile(userId) {
            const user = AppState.users.find(u => u.id === userId);
            if (!user) return;
            
            document.getElementById('modal-user-name').textContent = user.name;
            document.getElementById('modal-user-fullname').textContent = user.name;
            document.getElementById('modal-user-avatar').textContent = user.avatar;
            document.getElementById('modal-user-bio').textContent = user.bio;
            document.getElementById('modal-posts-count').textContent = user.posts;
            document.getElementById('modal-followers-count').textContent = user.followers;
            document.getElementById('modal-following-count').textContent = user.following;
            
            const followBtn = document.getElementById('follow-btn');
            if (user.isFollowing) {
                followBtn.innerHTML = '<i class="fas fa-user-check"></i> Abonné';
                followBtn.classList.remove('btn-primary');
                followBtn.classList.add('btn-success');
            } else {
                followBtn.innerHTML = '<i class="fas fa-user-plus"></i> S\'abonner';
                followBtn.classList.remove('btn-success');
                followBtn.classList.add('btn-primary');
            }
            
            document.getElementById('user-profile-modal').classList.remove('hidden');
        }

        function toggleFollow() {
            const user = AppState.users.find(u => u.id === AppState.users[0].id);
            if (!user) return;
            
            user.isFollowing = !user.isFollowing;
            user.followers += user.isFollowing ? 1 : -1;
            
            if (AppState.currentUser) {
                AppState.currentUser.following += user.isFollowing ? 1 : -1;
            }
            
            showUserProfile(user.id);
            showNotification(user.isFollowing ? 'Abonnement réussi!' : 'Désabonnement réussi!', 'success');
        }

        function reportPost(postId) {
            AppState.reportedPostId = postId;
            document.getElementById('report-modal').classList.remove('hidden');
        }

        function submitReport() {
            const reason = document.getElementById('report-reason').value;
            const description = document.getElementById('report-description').value;
            
            if (!description.trim()) {
                showNotification('Veuillez décrire le problème', 'error');
                return;
            }
            
            closeReportModal();
            showNotification('Signalement envoyé. Merci!', 'success');
        }

        function showLocationPicker() {
            showNotification('Sélection de localisation en développement', 'info');
        }

        function tagFriends() {
            showNotification('Marquage d\'amis en développement', 'info');
        }

        function focusComment(postId) {
            const commentInput = document.querySelector(`#comments-${postId} .comment-input`);
            if (commentInput) {
                commentInput.focus();
            }
        }

        // ===== INITIAL SHOP SETUP =====
        function initializeShop() {
            calculateDeliveryPrice();
        }

        // ===== OLD MESSAGES FUNCTIONS =====
        function simulateMessages() {
            AppState.messages = [
                {
                    id: 1,
                    sender: 'driver',
                    name: 'Jean Rakoto',
                    text: 'Bonjour ! Je suis en route. Je serai là dans 5 minutes.',
                    time: '10:25',
                    avatar: '👨'
                },
                {
                    id: 2,
                    sender: 'user',
                    name: 'Vous',
                    text: 'Parfait, je vous attends devant l\'entrée principale.',
                    time: '10:26',
                    avatar: '👤'
                },
                {
                    id: 3,
                    sender: 'driver',
                    name: 'Jean Rakoto',
                    text: 'Je viens d\'arriver. Je suis dans une Toyota blanche.',
                    time: '10:30',
                    avatar: '👨'
                }
            ];
        }

        function callDriver() {
            if (!AppState.currentDriver) {
                showNotification('Aucun chauffeur sélectionné', 'error');
                return;
            }
            
            showNotification(`Appel du chauffeur ${AppState.currentDriver.name}...`, 'info');
            setTimeout(() => {
                showNotification('Appel simulé avec succès', 'success');
            }, 1000);
        }

        // ===== INITIAL APP SETUP =====
        window.addEventListener('load', () => {
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    e.target.classList.add('hidden');
                }
            });
            
            document.addEventListener('touchstart', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    e.target.style.fontSize = '16px';
                }
            });
        });

        document.addEventListener('touchmove', (e) => {
            if (e.target.closest('.modal-content')) {
                e.stopPropagation();
            }
        }, { passive: false });

        if ('standalone' in window.navigator) {
            document.documentElement.style.height = '100%';
            document.body.style.height = '100%';
        }

        initializeApp();
    </script>
</body>
</html>
